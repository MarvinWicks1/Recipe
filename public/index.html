<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Keeper</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="A beautiful, rustic recipe keeper app for storing and organizing your favorite recipes">
    <meta name="theme-color" content="#9caf88">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Recipe Keeper">
    <meta name="msapplication-TileColor" content="#9caf88">
    <meta name="msapplication-TileImage" content="icon-192.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-apple-touch.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cream: #faf7f2;
            --warm-white: #f8f5f0;
            --sage: #9caf88;
            --deep-sage: #7a8b6b;
            --terracotta: #c17b5c;
            --soft-brown: #8b6f47;
            --charcoal: #3a3a3a;
            --light-sage: #b8c9a8;
            --shadow: rgba(0, 0, 0, 0.1);
            --soft-shadow: rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--warm-white) 100%);
            min-height: 100vh;
            color: var(--charcoal);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: var(--warm-white);
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
        }

        .header h1 {
            font-family: 'Libre Baskerville', serif;
            font-size: 3.2rem;
            color: var(--deep-sage);
            margin-bottom: 10px;
            text-shadow: 0 2px 4px var(--soft-shadow);
        }

        .header p {
            font-size: 1.2rem;
            color: var(--soft-brown);
            font-style: italic;
        }

        .main-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: var(--sage);
            color: white;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 175, 136, 0.3);
        }

        .nav-btn:hover {
            background: var(--deep-sage);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 175, 136, 0.4);
        }

        .nav-btn.active {
            background: var(--terracotta);
            box-shadow: 0 4px 15px rgba(193, 123, 92, 0.3);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .import-section {
            background: var(--warm-white);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
        }

        .import-section h2 {
            font-family: 'Libre Baskerville', serif;
            color: var(--deep-sage);
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--soft-brown);
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--light-sage);
            border-radius: 10px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            background: var(--cream);
            transition: border-color 0.3s ease;
            resize: vertical;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(156, 175, 136, 0.1);
        }

        .btn-primary {
            background: var(--sage);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 175, 136, 0.3);
        }

        .btn-primary:hover {
            background: var(--deep-sage);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 175, 136, 0.4);
        }

        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .recipe-card {
            background: var(--warm-white);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px var(--shadow);
        }

        .recipe-card h3 {
            font-family: 'Libre Baskerville', serif;
            color: var(--deep-sage);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .recipe-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--soft-brown);
        }

        .recipe-meta span {
            background: var(--light-sage);
            padding: 4px 12px;
            border-radius: 15px;
            color: white;
        }

        .recipe-preview {
            color: var(--charcoal);
            font-size: 1rem;
            line-height: 1.5;
        }

        .recipe-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 15px;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: var(--sage);
            color: white;
        }

        .btn-delete {
            background: var(--terracotta);
            color: white;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .search-bar {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 30px auto;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--light-sage);
            border-radius: 25px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            background: var(--cream);
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(156, 175, 136, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--warm-white);
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-sage);
        }

        .modal-title {
            font-family: 'Libre Baskerville', serif;
            font-size: 2rem;
            color: var(--deep-sage);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--soft-brown);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .close-btn:hover {
            background: var(--light-sage);
            color: white;
        }

        .recipe-detail {
            font-size: 1.1rem;
            line-height: 1.7;
        }

        .recipe-detail h4 {
            font-family: 'Libre Baskerville', serif;
            color: var(--deep-sage);
            margin: 25px 0 15px 0;
            font-size: 1.3rem;
        }

        .recipe-detail ul, .recipe-detail ol {
            margin-left: 20px;
            margin-bottom: 20px;
        }

        .recipe-detail li {
            margin-bottom: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--soft-brown);
        }

        .empty-state h3 {
            font-family: 'Libre Baskerville', serif;
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--deep-sage);
        }

        .empty-state p {
            font-size: 1.2rem;
            font-style: italic;
        }

        /* Category Section Styles */
        .category-section {
            background: var(--cream);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border: 1px solid rgba(156, 175, 136, 0.2);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--soft-brown);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .checkbox-label:hover {
            background: var(--light-sage);
            color: white;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        /* Filter Section Styles */
        .filter-section {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: var(--soft-brown);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .filter-control {
            padding: 10px;
            border: 2px solid var(--light-sage);
            border-radius: 8px;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            background: var(--cream);
            transition: border-color 0.3s ease;
        }

        .filter-control:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(156, 175, 136, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-filter {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-apply {
            background: var(--sage);
            color: white;
        }

        .btn-clear {
            background: var(--light-sage);
            color: white;
        }

        .btn-filter:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Recipe Card Category Tags */
        .recipe-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .category-tag {
            background: var(--light-sage);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .category-tag.type { background: var(--sage); }
        .category-tag.ingredient { background: var(--terracotta); }
        .category-tag.cuisine { background: var(--soft-brown); }
        .category-tag.difficulty { background: var(--deep-sage); }
        .category-tag.time { background: #8b6f47; }
        .category-tag.dietary { background: #7a8b6b; }

        /* Sort Options */
        .sort-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sort-label {
            color: var(--soft-brown);
            font-weight: 600;
            font-size: 1rem;
        }

        .sort-select {
            padding: 8px 15px;
            border: 2px solid var(--light-sage);
            border-radius: 8px;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            background: var(--cream);
            color: var(--charcoal);
        }

        /* Categories Section Styles */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .category-card {
            background: var(--warm-white);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px var(--shadow);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-name {
            font-family: 'Libre Baskerville', serif;
            font-size: 1.3rem;
            color: var(--deep-sage);
            font-weight: 600;
        }

        .category-count {
            background: var(--sage);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .category-recipes {
            margin-top: 15px;
        }

        .category-recipe-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-sage);
        }

        .category-recipe-item:last-child {
            border-bottom: none;
        }

        .category-recipe-title {
            color: var(--charcoal);
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .category-recipe-title:hover {
            color: var(--deep-sage);
        }

        .category-recipe-actions {
            display: flex;
            gap: 5px;
        }

        .btn-tiny {
            padding: 4px 8px;
            border: none;
            border-radius: 8px;
            font-family: 'Crimson Text', serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view {
            background: var(--sage);
            color: white;
        }

        .btn-edit {
            background: var(--light-sage);
            color: white;
        }

        .btn-tiny:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .recipes-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .recipe-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Recipe Keeper</h1>
            <p>Gather your favorite recipes in one cozy place</p>
        </header>

        <nav class="main-nav">
            <button class="nav-btn active" data-section="import">Add Recipe</button>
            <button class="nav-btn" data-section="recipes">My Recipes</button>
            <button class="nav-btn" data-section="categories">Categories</button>
            <button class="nav-btn" onclick="recipeKeeper.showBackupOptions()">‚öôÔ∏è Backup</button>
        </nav>

        <!-- Import Recipe Section -->
        <section id="import" class="section active">
            <div class="import-section">
                <h2>Add a New Recipe</h2>
                <p style="margin-bottom: 25px; color: var(--soft-brown); font-style: italic;">
                    Simply paste your recipe text below, and I'll help organize it beautifully for you.
                </p>
                
                <form id="recipeForm">
                    <div class="form-group">
                        <label for="recipeTitle">Recipe Title</label>
                        <input type="text" id="recipeTitle" class="form-control" placeholder="Enter a title for your recipe" required>
                    </div>

                    <div class="form-group">
                        <label for="recipeText">Recipe Content</label>
                        <textarea id="recipeText" class="form-control" rows="12" 
                            placeholder="Paste your recipe here... Include ingredients, instructions, cooking times, etc. I'll help organize it!" required></textarea>
                    </div>

                    <!-- Category Selection Section -->
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; font-size: 1.3rem; margin: 0;">Recipe Categories</h3>
                            <button type="button" id="autoDetectBtn" class="btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">
                                ü§ñ Auto-Detect
                            </button>
                        </div>
                        
                        <div class="category-grid">
                            <div class="form-group">
                                <label for="recipeType">Recipe Type</label>
                                <select id="recipeType" class="form-control">
                                    <option value="">Select type...</option>
                                    <option value="appetizer">Appetizer</option>
                                    <option value="main-course">Main Course</option>
                                    <option value="side-dish">Side Dish</option>
                                    <option value="dessert">Dessert</option>
                                    <option value="breakfast">Breakfast</option>
                                    <option value="lunch">Lunch</option>
                                    <option value="dinner">Dinner</option>
                                    <option value="snack">Snack</option>
                                    <option value="beverage">Beverage</option>
                                    <option value="soup">Soup</option>
                                    <option value="salad">Salad</option>
                                    <option value="sauce">Sauce</option>
                                    <option value="bread">Bread</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="mainIngredient">Main Ingredient</label>
                                <select id="mainIngredient" class="form-control">
                                    <option value="">Select main ingredient...</option>
                                    <option value="chicken">Chicken</option>
                                    <option value="beef">Beef</option>
                                    <option value="pork">Pork</option>
                                    <option value="fish">Fish</option>
                                    <option value="seafood">Seafood</option>
                                    <option value="vegetables">Vegetables</option>
                                    <option value="pasta">Pasta</option>
                                    <option value="rice">Rice</option>
                                    <option value="potatoes">Potatoes</option>
                                    <option value="eggs">Eggs</option>
                                    <option value="cheese">Cheese</option>
                                    <option value="beans">Beans/Legumes</option>
                                    <option value="nuts">Nuts</option>
                                    <option value="fruits">Fruits</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="cuisine">Cuisine</label>
                                <select id="cuisine" class="form-control">
                                    <option value="">Select cuisine...</option>
                                    <option value="american">American</option>
                                    <option value="italian">Italian</option>
                                    <option value="mexican">Mexican</option>
                                    <option value="chinese">Chinese</option>
                                    <option value="indian">Indian</option>
                                    <option value="french">French</option>
                                    <option value="thai">Thai</option>
                                    <option value="japanese">Japanese</option>
                                    <option value="mediterranean">Mediterranean</option>
                                    <option value="middle-eastern">Middle Eastern</option>
                                    <option value="korean">Korean</option>
                                    <option value="greek">Greek</option>
                                    <option value="spanish">Spanish</option>
                                    <option value="german">German</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="difficulty">Difficulty</label>
                                <select id="difficulty" class="form-control">
                                    <option value="">Select difficulty...</option>
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="cookTime">Cooking Time</label>
                                <select id="cookTime" class="form-control">
                                    <option value="">Select time...</option>
                                    <option value="under-15">Under 15 minutes</option>
                                    <option value="15-30">15-30 minutes</option>
                                    <option value="30-60">30-60 minutes</option>
                                    <option value="1-2-hours">1-2 hours</option>
                                    <option value="over-2-hours">Over 2 hours</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="dietary">Dietary Restrictions</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="vegetarian"> Vegetarian
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="vegan"> Vegan
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="gluten-free"> Gluten-Free
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="dairy-free"> Dairy-Free
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="keto"> Keto
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="paleo"> Paleo
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">Save Recipe</button>
                </form>
            </div>
        </section>

        <!-- Recipes List Section -->
        <section id="recipes" class="section">
            <div class="search-bar">
                <input type="text" id="searchInput" class="search-input" placeholder="Search your recipes...">
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <h3 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; margin-bottom: 20px; font-size: 1.3rem;">Filter & Sort Recipes</h3>
                
                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="filterType">Recipe Type</label>
                        <select id="filterType" class="filter-control">
                            <option value="">All Types</option>
                            <option value="appetizer">Appetizer</option>
                            <option value="main-course">Main Course</option>
                            <option value="side-dish">Side Dish</option>
                            <option value="dessert">Dessert</option>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                            <option value="beverage">Beverage</option>
                            <option value="soup">Soup</option>
                            <option value="salad">Salad</option>
                            <option value="sauce">Sauce</option>
                            <option value="bread">Bread</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterIngredient">Main Ingredient</label>
                        <select id="filterIngredient" class="filter-control">
                            <option value="">All Ingredients</option>
                            <option value="chicken">Chicken</option>
                            <option value="beef">Beef</option>
                            <option value="pork">Pork</option>
                            <option value="fish">Fish</option>
                            <option value="seafood">Seafood</option>
                            <option value="vegetables">Vegetables</option>
                            <option value="pasta">Pasta</option>
                            <option value="rice">Rice</option>
                            <option value="potatoes">Potatoes</option>
                            <option value="eggs">Eggs</option>
                            <option value="cheese">Cheese</option>
                            <option value="beans">Beans/Legumes</option>
                            <option value="nuts">Nuts</option>
                            <option value="fruits">Fruits</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterCuisine">Cuisine</label>
                        <select id="filterCuisine" class="filter-control">
                            <option value="">All Cuisines</option>
                            <option value="american">American</option>
                            <option value="italian">Italian</option>
                            <option value="mexican">Mexican</option>
                            <option value="chinese">Chinese</option>
                            <option value="indian">Indian</option>
                            <option value="french">French</option>
                            <option value="thai">Thai</option>
                            <option value="japanese">Japanese</option>
                            <option value="mediterranean">Mediterranean</option>
                            <option value="middle-eastern">Middle Eastern</option>
                            <option value="korean">Korean</option>
                            <option value="greek">Greek</option>
                            <option value="spanish">Spanish</option>
                            <option value="german">German</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterDifficulty">Difficulty</label>
                        <select id="filterDifficulty" class="filter-control">
                            <option value="">All Levels</option>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterTime">Cooking Time</label>
                        <select id="filterTime" class="filter-control">
                            <option value="">All Times</option>
                            <option value="under-15">Under 15 minutes</option>
                            <option value="15-30">15-30 minutes</option>
                            <option value="30-60">30-60 minutes</option>
                            <option value="1-2-hours">1-2 hours</option>
                            <option value="over-2-hours">Over 2 hours</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterDietary">Dietary</label>
                        <select id="filterDietary" class="filter-control">
                            <option value="">All Dietary</option>
                            <option value="vegetarian">Vegetarian</option>
                            <option value="vegan">Vegan</option>
                            <option value="gluten-free">Gluten-Free</option>
                            <option value="dairy-free">Dairy-Free</option>
                            <option value="keto">Keto</option>
                            <option value="paleo">Paleo</option>
                        </select>
                    </div>
                </div>

                <div class="filter-actions">
                    <button id="applyFilters" class="btn-filter btn-apply">Apply Filters</button>
                    <button id="clearFilters" class="btn-filter btn-clear">Clear All</button>
                </div>
            </div>

            <!-- Sort Section -->
            <div class="sort-section">
                <span class="sort-label">Sort by:</span>
                <select id="sortSelect" class="sort-select">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="title-az">Title A-Z</option>
                    <option value="title-za">Title Z-A</option>
                    <option value="difficulty-easy">Difficulty: Easy to Hard</option>
                    <option value="difficulty-hard">Difficulty: Hard to Easy</option>
                    <option value="time-short">Time: Short to Long</option>
                    <option value="time-long">Time: Long to Short</option>
                </select>
            </div>
            
            <div id="recipesContainer">
                <div class="empty-state">
                    <h3>Your Recipe Collection Awaits</h3>
                    <p>Start by adding your first recipe using the "Add Recipe" tab above.</p>
                </div>
            </div>
        </section>

        <!-- Categories Management Section -->
        <section id="categories" class="section">
            <div class="import-section">
                <h2>Recipe Categories</h2>
                <p style="margin-bottom: 25px; color: var(--soft-brown); font-style: italic;">
                    View and manage your recipe categories. See how many recipes you have in each category.
                </p>
                
                <div id="categoriesContainer">
                    <div class="empty-state">
                        <h3>No Categories Yet</h3>
                        <p>Add some recipes with categories to see them organized here.</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Recipe Detail Modal -->
    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Recipe Title</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="recipe-detail" id="modalContent">
                <!-- Recipe content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        class RecipeKeeper {
            constructor() {
                this.recipes = this.loadRecipes();
                this.currentEditId = null;
                this.initializeEventListeners();
                this.renderRecipes();
            }

            initializeEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchSection(e.target.dataset.section));
                });

                // Form submission
                document.getElementById('recipeForm').addEventListener('submit', (e) => this.handleFormSubmit(e));

                // Search
                document.getElementById('searchInput').addEventListener('input', (e) => this.handleSearch(e.target.value));

                // Filter controls
                document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
                document.getElementById('clearFilters').addEventListener('click', () => this.clearFilters());
                document.getElementById('sortSelect').addEventListener('change', (e) => this.handleSort(e.target.value));

                // Auto-detect categories
                document.getElementById('autoDetectBtn').addEventListener('click', () => this.autoDetectCategories());

                // Modal
                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());
                document.getElementById('recipeModal').addEventListener('click', (e) => {
                    if (e.target.id === 'recipeModal') this.closeModal();
                });

                // Escape key to close modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeModal();
                });
            }

            switchSection(sectionName) {
                // Update nav buttons
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

                // Update sections
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                document.getElementById(sectionName).classList.add('active');

                if (sectionName === 'recipes') {
                    this.renderRecipes();
                } else if (sectionName === 'categories') {
                    this.renderCategories();
                }
            }

            async handleFormSubmit(e) {
                e.preventDefault();
                const title = document.getElementById('recipeTitle').value.trim();
                const content = document.getElementById('recipeText').value.trim();

                if (!title || !content) return;

                // Show loading for longer recipes
                if (content.length > 1000) {
                    this.showLoading('Organizing your recipe...');
                }

                try {
                    // Use setTimeout to allow UI to update
                    const processedRecipe = await new Promise(resolve => {
                        setTimeout(() => {
                            resolve(this.processRecipeContent(title, content));
                        }, 10);
                    });
                    
                    if (this.currentEditId) {
                        this.updateRecipe(this.currentEditId, processedRecipe);
                        this.currentEditId = null;
                    } else {
                        this.addRecipe(processedRecipe);
                    }

                    this.resetForm();
                    this.switchSection('recipes');
                } catch (error) {
                    console.error('Error processing recipe:', error);
                    alert('There was an error processing your recipe. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }

            processRecipeContent(title, content) {
                const recipe = {
                    id: this.currentEditId || Date.now().toString(),
                    title: title.trim(),
                    content: content.trim(),
                    createdAt: new Date().toISOString(),
                    ingredients: [],
                    instructions: [],
                    servings: '',
                    prepTime: '',
                    cookTime: '',
                    // New category fields
                    type: document.getElementById('recipeType').value,
                    mainIngredient: document.getElementById('mainIngredient').value,
                    cuisine: document.getElementById('cuisine').value,
                    difficulty: document.getElementById('difficulty').value,
                    cookTimeCategory: document.getElementById('cookTime').value,
                    dietary: this.getSelectedDietaryRestrictions()
                };

                // Auto-detect categories if not already set
                if (!recipe.type) {
                    recipe.type = this.detectRecipeType(title, content);
                }
                if (!recipe.mainIngredient) {
                    recipe.mainIngredient = this.detectMainIngredient(content);
                }
                if (!recipe.cuisine) {
                    recipe.cuisine = this.detectCuisine(title, content);
                }
                if (!recipe.difficulty) {
                    recipe.difficulty = this.detectDifficulty(content);
                }
                if (!recipe.cookTimeCategory) {
                    recipe.cookTimeCategory = this.detectCookingTime(content);
                }
                if (!recipe.dietary || recipe.dietary.length === 0) {
                    recipe.dietary = this.detectDietaryRestrictions(content);
                }

                // Quick extraction - only process if content is reasonable length
                if (content.length > 50000) {
                    // For very long content, skip processing to avoid slowdown
                    return recipe;
                }

                // Pre-compile regex patterns for better performance
                const sectionPatterns = {
                    ingredients: /(ingredient|what you need)/i,
                    instructions: /(instruction|method|directions|steps|how to make)/i,
                    servings: /(serves?|serving)/i,
                    prepTime: /prep.*time/i,
                    cookTime: /cook.*time/i
                };

                const lines = content.split('\n');
                let currentSection = 'general';
                const ingredients = [];
                const instructions = [];
                
                // Process lines more efficiently
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const lowerLine = line.toLowerCase();
                    
                    // Check for section headers
                    if (sectionPatterns.ingredients.test(lowerLine)) {
                        currentSection = 'ingredients';
                        continue;
                    }
                    if (sectionPatterns.instructions.test(lowerLine)) {
                        currentSection = 'instructions';
                        continue;
                    }
                    
                    // Extract meta information (only check first 20 lines for performance)
                    if (i < 20) {
                        if (sectionPatterns.servings.test(lowerLine)) {
                            recipe.servings = line;
                            continue;
                        }
                        if (sectionPatterns.prepTime.test(lowerLine)) {
                            recipe.prepTime = line;
                            continue;
                        }
                        if (sectionPatterns.cookTime.test(lowerLine)) {
                            recipe.cookTime = line;
                            continue;
                        }
                    }
                    
                    // Categorize content based on current section
                    if (currentSection === 'ingredients' && !sectionPatterns.ingredients.test(lowerLine)) {
                        ingredients.push(line);
                    } else if (currentSection === 'instructions' && 
                               !sectionPatterns.instructions.test(lowerLine) &&
                               !sectionPatterns.ingredients.test(lowerLine)) {
                        instructions.push(line);
                    }
                }
                
                recipe.ingredients = ingredients;
                recipe.instructions = instructions;
                
                return recipe;
            }

            addRecipe(recipe) {
                this.recipes.push(recipe);
                this.saveRecipes();
                this.renderRecipes();
            }

            updateRecipe(id, updatedRecipe) {
                const index = this.recipes.findIndex(r => r.id === id);
                if (index !== -1) {
                    this.recipes[index] = { ...updatedRecipe, id };
                    this.saveRecipes();
                    this.renderRecipes();
                }
            }

            deleteRecipe(id) {
                const recipe = this.recipes.find(r => r.id === id);
                if (!recipe) return;

                this.showDeleteConfirmation(recipe.title, () => {
                    this.recipes = this.recipes.filter(r => r.id !== id);
                    this.saveRecipes();
                    this.renderRecipes();
                });
            }

            showDeleteConfirmation(recipeName, onConfirm) {
                const modal = document.createElement('div');
                modal.id = 'delete-confirmation-modal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--warm-white); padding: 30px; border-radius: 15px; box-shadow: 0 8px 32px var(--shadow); max-width: 400px; width: 90%; text-align: center;">
                            <h3 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; margin-bottom: 15px;">Delete Recipe?</h3>
                            <p style="color: var(--soft-brown); margin-bottom: 25px; font-size: 1.1rem;">Are you sure you want to delete "${this.escapeHtml(recipeName)}"? This action cannot be undone.</p>
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button id="cancel-delete" style="background: var(--light-sage); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1rem; cursor: pointer;">Cancel</button>
                                <button id="confirm-delete" style="background: var(--terracotta); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1rem; cursor: pointer;">Delete</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const cancelBtn = modal.querySelector('#cancel-delete');
                const confirmBtn = modal.querySelector('#confirm-delete');

                const cleanup = () => {
                    modal.remove();
                };

                cancelBtn.addEventListener('click', cleanup);
                confirmBtn.addEventListener('click', () => {
                    onConfirm();
                    cleanup();
                });

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) cleanup();
                });

                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            }

            editRecipe(id) {
                const recipe = this.recipes.find(r => r.id === id);
                if (recipe) {
                    document.getElementById('recipeTitle').value = recipe.title;
                    document.getElementById('recipeText').value = recipe.content;
                    
                    // Populate category fields
                    if (recipe.type) document.getElementById('recipeType').value = recipe.type;
                    if (recipe.mainIngredient) document.getElementById('mainIngredient').value = recipe.mainIngredient;
                    if (recipe.cuisine) document.getElementById('cuisine').value = recipe.cuisine;
                    if (recipe.difficulty) document.getElementById('difficulty').value = recipe.difficulty;
                    if (recipe.cookTimeCategory) document.getElementById('cookTime').value = recipe.cookTimeCategory;
                    
                    // Clear and set dietary restrictions
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    if (recipe.dietary) {
                        recipe.dietary.forEach(diet => {
                            const checkbox = document.querySelector(`input[value="${diet}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    
                    this.currentEditId = id;
                    this.switchSection('import');
                }
            }

            buildCategoryTags(recipe) {
                let tags = '';
                
                if (recipe.type) {
                    tags += `<span class="category-tag type">${this.formatCategoryValue(recipe.type)}</span>`;
                }
                if (recipe.mainIngredient) {
                    tags += `<span class="category-tag ingredient">${this.formatCategoryValue(recipe.mainIngredient)}</span>`;
                }
                if (recipe.cuisine) {
                    tags += `<span class="category-tag cuisine">${this.formatCategoryValue(recipe.cuisine)}</span>`;
                }
                if (recipe.difficulty) {
                    tags += `<span class="category-tag difficulty">${this.formatCategoryValue(recipe.difficulty)}</span>`;
                }
                if (recipe.cookTimeCategory) {
                    tags += `<span class="category-tag time">${this.formatCategoryValue(recipe.cookTimeCategory)}</span>`;
                }
                if (recipe.dietary && recipe.dietary.length > 0) {
                    recipe.dietary.forEach(diet => {
                        tags += `<span class="category-tag dietary">${this.formatCategoryValue(diet)}</span>`;
                    });
                }
                
                return tags;
            }

            formatCategoryValue(value) {
                return value.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            // Intelligent Category Detection Methods
            detectRecipeType(title, content) {
                const text = (title + ' ' + content).toLowerCase();
                
                // Breakfast patterns
                if (/\b(breakfast|pancake|waffle|omelet|omelette|french toast|granola|cereal|muffin|bagel|toast|eggs|bacon|sausage|hash|frittata)\b/.test(text)) {
                    return 'breakfast';
                }
                
                // Appetizer patterns
                if (/\b(appetizer|starter|hors d'oeuvre|dip|spread|bruschetta|crostini|canap√©|finger food|snack|nibble)\b/.test(text)) {
                    return 'appetizer';
                }
                
                // Soup patterns
                if (/\b(soup|broth|bisque|chowder|gazpacho|consomm√©|stew|gumbo|chili)\b/.test(text)) {
                    return 'soup';
                }
                
                // Salad patterns
                if (/\b(salad|lettuce|greens|caesar|cobb|ni√ßoise|caprese|coleslaw|slaw)\b/.test(text)) {
                    return 'salad';
                }
                
                // Dessert patterns
                if (/\b(dessert|cake|pie|tart|cookie|brownie|ice cream|pudding|mousse|cheesecake|truffle|candy|sweet|chocolate|sugar)\b/.test(text)) {
                    return 'dessert';
                }
                
                // Beverage patterns
                if (/\b(drink|beverage|smoothie|juice|tea|coffee|cocktail|mocktail|punch|lemonade|soda)\b/.test(text)) {
                    return 'beverage';
                }
                
                // Bread patterns
                if (/\b(bread|loaf|roll|bun|bagel|pretzel|flatbread|naan|pita|focaccia|sourdough)\b/.test(text)) {
                    return 'bread';
                }
                
                // Sauce patterns
                if (/\b(sauce|dressing|marinade|glaze|syrup|reduction|gravy|pesto|aioli|mayo|ketchup|mustard)\b/.test(text)) {
                    return 'sauce';
                }
                
                // Main course (default for substantial recipes)
                if (/\b(beef|chicken|pork|fish|seafood|pasta|rice|quinoa|beans|lentils|tofu|tempeh|main|dinner|lunch)\b/.test(text)) {
                    return 'main-course';
                }
                
                // Side dish patterns
                if (/\b(side|accompaniment|vegetable|potato|fries|mashed|roasted|steamed|grilled|saut√©ed)\b/.test(text)) {
                    return 'side-dish';
                }
                
                return 'main-course'; // Default fallback
            }

            detectMainIngredient(content) {
                const text = content.toLowerCase();
                
                // Protein detection
                if (/\b(chicken|poultry|hen|breast|thigh|wing|drumstick)\b/.test(text)) return 'chicken';
                if (/\b(beef|steak|ground beef|hamburger|roast|brisket|ribs)\b/.test(text)) return 'beef';
                if (/\b(pork|ham|bacon|sausage|chop|tenderloin|ribs)\b/.test(text)) return 'pork';
                if (/\b(fish|salmon|tuna|cod|halibut|trout|bass|mackerel|sardine)\b/.test(text)) return 'fish';
                if (/\b(seafood|shrimp|prawn|crab|lobster|scallop|mussel|oyster|clam|squid|octopus)\b/.test(text)) return 'seafood';
                
                // Starch detection
                if (/\b(pasta|noodle|spaghetti|penne|fettuccine|macaroni|lasagna|ravioli)\b/.test(text)) return 'pasta';
                if (/\b(rice|basmati|jasmine|brown rice|wild rice|risotto|arroz)\b/.test(text)) return 'rice';
                if (/\b(potato|potatoes|sweet potato|yam|mashed|fries|hash)\b/.test(text)) return 'potatoes';
                
                // Other proteins
                if (/\b(egg|eggs|omelet|omelette|frittata|quiche)\b/.test(text)) return 'eggs';
                if (/\b(cheese|cheddar|mozzarella|parmesan|feta|goat cheese|ricotta)\b/.test(text)) return 'cheese';
                if (/\b(bean|beans|lentil|lentils|chickpea|black bean|kidney bean|pinto bean)\b/.test(text)) return 'beans';
                if (/\b(nut|nuts|almond|walnut|pecan|cashew|pistachio|peanut)\b/.test(text)) return 'nuts';
                
                // Fruits and vegetables
                if (/\b(fruit|apple|banana|berry|strawberry|blueberry|orange|lemon|lime|grape|peach|pear)\b/.test(text)) return 'fruits';
                if (/\b(vegetable|vegetables|carrot|onion|garlic|tomato|pepper|broccoli|spinach|lettuce|celery|cucumber)\b/.test(text)) return 'vegetables';
                
                return 'other';
            }

            detectCuisine(title, content) {
                const text = (title + ' ' + content).toLowerCase();
                
                // Italian patterns
                if (/\b(italian|pasta|pizza|risotto|bruschetta|parmesan|mozzarella|basil|oregano|marinara|alfredo|carbonara|pesto|gnocchi|ravioli|lasagna)\b/.test(text)) {
                    return 'italian';
                }
                
                // Mexican patterns
                if (/\b(mexican|taco|burrito|enchilada|quesadilla|salsa|guacamole|jalape√±o|cilantro|cumin|chili|tortilla|fajita|nacho)\b/.test(text)) {
                    return 'mexican';
                }
                
                // Chinese patterns
                if (/\b(chinese|soy sauce|ginger|sesame|wok|stir fry|lo mein|fried rice|dumpling|wonton|bok choy|hoisin|oyster sauce)\b/.test(text)) {
                    return 'chinese';
                }
                
                // Indian patterns
                if (/\b(indian|curry|masala|garam|tandoor|naan|basmati|cardamom|cumin|coriander|turmeric|ginger|garlic|chili|dal|lentil)\b/.test(text)) {
                    return 'indian';
                }
                
                // French patterns
                if (/\b(french|herbes de provence|thyme|rosemary|tarragon|dijon|b√©chamel|hollandaise|ratatouille|coq au vin|bouillabaisse)\b/.test(text)) {
                    return 'french';
                }
                
                // Thai patterns
                if (/\b(thai|lemongrass|galangal|fish sauce|coconut milk|curry paste|pad thai|tom yum|basil|mint|cilantro|kaffir lime)\b/.test(text)) {
                    return 'thai';
                }
                
                // Japanese patterns
                if (/\b(japanese|sushi|sashimi|miso|soy sauce|wasabi|ginger|teriyaki|tempura|ramen|udon|mirin|sake)\b/.test(text)) {
                    return 'japanese';
                }
                
                // Mediterranean patterns
                if (/\b(mediterranean|olive oil|feta|olives|sun dried tomato|artichoke|hummus|tzatziki|oregano|basil|lemon|garlic)\b/.test(text)) {
                    return 'mediterranean';
                }
                
                // Middle Eastern patterns
                if (/\b(middle eastern|hummus|tahini|pita|falafel|sumac|za'atar|cardamom|cinnamon|pistachio|pomegranate|yogurt)\b/.test(text)) {
                    return 'middle-eastern';
                }
                
                // Korean patterns
                if (/\b(korean|kimchi|gochujang|sesame oil|soy sauce|garlic|ginger|scallion|bulgogi|bibimbap|korean bbq)\b/.test(text)) {
                    return 'korean';
                }
                
                // Greek patterns
                if (/\b(greek|feta|olive|oregano|lemon|garlic|tzatziki|hummus|pita|spanakopita|moussaka|baklava)\b/.test(text)) {
                    return 'greek';
                }
                
                // Spanish patterns
                if (/\b(spanish|paella|saffron|chorizo|jam√≥n|sherry|olive oil|garlic|paprika|sangria|tapas|gazpacho)\b/.test(text)) {
                    return 'spanish';
                }
                
                // German patterns
                if (/\b(german|sauerkraut|bratwurst|beer|mustard|caraway|dill|potato|cabbage|pretzel|schnitzel)\b/.test(text)) {
                    return 'german';
                }
                
                return 'american'; // Default fallback
            }

            detectDifficulty(content) {
                const text = content.toLowerCase();
                
                // Easy patterns
                if (/\b(simple|easy|quick|basic|minimal|few ingredients|no cook|raw|mix|stir|combine|toss|blend)\b/.test(text)) {
                    return 'easy';
                }
                
                // Hard patterns
                if (/\b(complex|advanced|difficult|challenging|multi step|layered|temper|sous vide|ferment|proof|knead|fold|whip|emulsify|caramelize|braise|confit)\b/.test(text)) {
                    return 'hard';
                }
                
                // Medium patterns
                if (/\b(medium|moderate|intermediate|saute|roast|bake|grill|fry|simmer|reduce|marinate|brine|rest|chill)\b/.test(text)) {
                    return 'medium';
                }
                
                // Time-based difficulty
                const timeWords = text.match(/\b(\d+)\s*(minute|hour|day)s?\b/g);
                if (timeWords) {
                    const totalMinutes = timeWords.reduce((total, time) => {
                        const match = time.match(/(\d+)\s*(minute|hour|day)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            const unit = match[2];
                            if (unit === 'hour') return total + (num * 60);
                            if (unit === 'day') return total + (num * 1440);
                            return total + num;
                        }
                        return total;
                    }, 0);
                    
                    if (totalMinutes <= 30) return 'easy';
                    if (totalMinutes <= 120) return 'medium';
                    return 'hard';
                }
                
                return 'medium'; // Default fallback
            }

            detectCookingTime(content) {
                const text = content.toLowerCase();
                
                // Extract time information
                const timeMatches = text.match(/\b(\d+)\s*(minute|hour|day)s?\b/g);
                if (!timeMatches) return '30-60'; // Default fallback
                
                let totalMinutes = 0;
                timeMatches.forEach(time => {
                    const match = time.match(/(\d+)\s*(minute|hour|day)/);
                    if (match) {
                        const num = parseInt(match[1]);
                        const unit = match[2];
                        if (unit === 'hour') totalMinutes += (num * 60);
                        else if (unit === 'day') totalMinutes += (num * 1440);
                        else totalMinutes += num;
                    }
                });
                
                if (totalMinutes <= 15) return 'under-15';
                if (totalMinutes <= 30) return '15-30';
                if (totalMinutes <= 60) return '30-60';
                if (totalMinutes <= 120) return '1-2-hours';
                return 'over-2-hours';
            }

            detectDietaryRestrictions(content) {
                const text = content.toLowerCase();
                const dietary = [];
                
                // Vegetarian detection
                if (/\b(vegetarian|veggie|no meat|plant based|vegetable|veggie)\b/.test(text) && 
                    !/\b(meat|chicken|beef|pork|fish|seafood|bacon|ham|sausage)\b/.test(text)) {
                    dietary.push('vegetarian');
                }
                
                // Vegan detection
                if (/\b(vegan|no dairy|no eggs|plant based|dairy free|egg free)\b/.test(text) && 
                    !/\b(meat|chicken|beef|pork|fish|seafood|dairy|milk|cheese|butter|cream|egg)\b/.test(text)) {
                    dietary.push('vegan');
                }
                
                // Gluten-free detection
                if (/\b(gluten free|gluten-free|no gluten|gf)\b/.test(text) && 
                    !/\b(wheat|flour|bread|pasta|barley|rye|oats)\b/.test(text)) {
                    dietary.push('gluten-free');
                }
                
                // Dairy-free detection
                if (/\b(dairy free|dairy-free|no dairy|lactose free|lactose-free)\b/.test(text) && 
                    !/\b(milk|cheese|butter|cream|yogurt|dairy)\b/.test(text)) {
                    dietary.push('dairy-free');
                }
                
                // Keto detection
                if (/\b(keto|ketogenic|low carb|low carb|no sugar|sugar free)\b/.test(text) && 
                    !/\b(bread|pasta|rice|potato|sugar|honey|maple syrup)\b/.test(text)) {
                    dietary.push('keto');
                }
                
                // Paleo detection
                if (/\b(paleo|paleolithic|primal|no grains|no dairy|no legumes)\b/.test(text) && 
                    !/\b(grains|dairy|legumes|beans|lentils|soy)\b/.test(text)) {
                    dietary.push('paleo');
                }
                
                return dietary;
            }

            autoDetectCategories() {
                const title = document.getElementById('recipeTitle').value.trim();
                const content = document.getElementById('recipeText').value.trim();
                
                if (!title && !content) {
                    this.showMessage('Please enter a recipe title and content first!', 'error');
                    return;
                }
                
                // Show loading
                this.showLoading('Analyzing recipe content...');
                
                // Simulate processing time for better UX
                setTimeout(() => {
                    // Auto-detect categories
                    const detectedType = this.detectRecipeType(title, content);
                    const detectedIngredient = this.detectMainIngredient(content);
                    const detectedCuisine = this.detectCuisine(title, content);
                    const detectedDifficulty = this.detectDifficulty(content);
                    const detectedTime = this.detectCookingTime(content);
                    const detectedDietary = this.detectDietaryRestrictions(content);
                    
                    // Update form fields
                    if (detectedType) {
                        document.getElementById('recipeType').value = detectedType;
                        this.highlightField('recipeType');
                    }
                    if (detectedIngredient) {
                        document.getElementById('mainIngredient').value = detectedIngredient;
                        this.highlightField('mainIngredient');
                    }
                    if (detectedCuisine) {
                        document.getElementById('cuisine').value = detectedCuisine;
                        this.highlightField('cuisine');
                    }
                    if (detectedDifficulty) {
                        document.getElementById('difficulty').value = detectedDifficulty;
                        this.highlightField('difficulty');
                    }
                    if (detectedTime) {
                        document.getElementById('cookTime').value = detectedTime;
                        this.highlightField('cookTime');
                    }
                    
                    // Update dietary checkboxes
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    detectedDietary.forEach(diet => {
                        const checkbox = document.querySelector(`input[value="${diet}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            this.highlightField(checkbox);
                        }
                    });
                    
                    this.hideLoading();
                    
                    const detectedCount = [detectedType, detectedIngredient, detectedCuisine, detectedDifficulty, detectedTime].filter(Boolean).length + detectedDietary.length;
                    this.showMessage(`ü§ñ Auto-detected ${detectedCount} categories!`, 'success');
                    
                }, 1000);
            }

            highlightField(fieldId) {
                const field = typeof fieldId === 'string' ? document.getElementById(fieldId) : fieldId;
                if (field) {
                    field.style.borderColor = 'var(--sage)';
                    field.style.boxShadow = '0 0 0 3px rgba(156, 175, 136, 0.3)';
                    
                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        field.style.borderColor = '';
                        field.style.boxShadow = '';
                    }, 3000);
                }
            }

            renderCategories() {
                const container = document.getElementById('categoriesContainer');
                
                // Group recipes by categories
                const categories = this.groupRecipesByCategories();
                
                if (Object.keys(categories).length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No Categories Yet</h3>
                            <p>Add some recipes with categories to see them organized here.</p>
                        </div>
                    `;
                    return;
                }

                const categoriesGrid = document.createElement('div');
                categoriesGrid.className = 'categories-grid';

                Object.keys(categories).forEach(categoryType => {
                    const categoryData = categories[categoryType];
                    
                    Object.keys(categoryData).forEach(categoryValue => {
                        const recipes = categoryData[categoryValue];
                        const categoryCard = document.createElement('div');
                        categoryCard.className = 'category-card';
                        
                        const categoryName = this.formatCategoryValue(categoryValue);
                        const categoryTypeName = this.formatCategoryValue(categoryType);
                        
                        let recipesList = '';
                        recipes.forEach(recipe => {
                            recipesList += `
                                <div class="category-recipe-item">
                                    <span class="category-recipe-title" onclick="recipeKeeper.viewRecipe('${recipe.id}')">
                                        ${this.escapeHtml(recipe.title)}
                                    </span>
                                    <div class="category-recipe-actions">
                                        <button class="btn-tiny btn-view" onclick="recipeKeeper.viewRecipe('${recipe.id}')">View</button>
                                        <button class="btn-tiny btn-edit" onclick="recipeKeeper.editRecipe('${recipe.id}')">Edit</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        categoryCard.innerHTML = `
                            <div class="category-header">
                                <span class="category-name">${categoryName}</span>
                                <span class="category-count">${recipes.length} recipe${recipes.length !== 1 ? 's' : ''}</span>
                            </div>
                            <div style="color: var(--soft-brown); font-size: 0.9rem; margin-bottom: 15px;">
                                ${categoryTypeName}
                            </div>
                            <div class="category-recipes">
                                ${recipesList}
                            </div>
                        `;
                        
                        categoriesGrid.appendChild(categoryCard);
                    });
                });

                container.innerHTML = '';
                container.appendChild(categoriesGrid);
            }

            groupRecipesByCategories() {
                const categories = {};
                
                this.recipes.forEach(recipe => {
                    // Group by type
                    if (recipe.type) {
                        if (!categories.type) categories.type = {};
                        if (!categories.type[recipe.type]) categories.type[recipe.type] = [];
                        categories.type[recipe.type].push(recipe);
                    }
                    
                    // Group by main ingredient
                    if (recipe.mainIngredient) {
                        if (!categories.mainIngredient) categories.mainIngredient = {};
                        if (!categories.mainIngredient[recipe.mainIngredient]) categories.mainIngredient[recipe.mainIngredient] = [];
                        categories.mainIngredient[recipe.mainIngredient].push(recipe);
                    }
                    
                    // Group by cuisine
                    if (recipe.cuisine) {
                        if (!categories.cuisine) categories.cuisine = {};
                        if (!categories.cuisine[recipe.cuisine]) categories.cuisine[recipe.cuisine] = [];
                        categories.cuisine[recipe.cuisine].push(recipe);
                    }
                    
                    // Group by difficulty
                    if (recipe.difficulty) {
                        if (!categories.difficulty) categories.difficulty = {};
                        if (!categories.difficulty[recipe.difficulty]) categories.difficulty[recipe.difficulty] = [];
                        categories.difficulty[recipe.difficulty].push(recipe);
                    }
                    
                    // Group by cooking time
                    if (recipe.cookTimeCategory) {
                        if (!categories.cookTimeCategory) categories.cookTimeCategory = {};
                        if (!categories.cookTimeCategory[recipe.cookTimeCategory]) categories.cookTimeCategory[recipe.cookTimeCategory] = [];
                        categories.cookTimeCategory[recipe.cookTimeCategory].push(recipe);
                    }
                    
                    // Group by dietary restrictions
                    if (recipe.dietary && recipe.dietary.length > 0) {
                        if (!categories.dietary) categories.dietary = {};
                        recipe.dietary.forEach(diet => {
                            if (!categories.dietary[diet]) categories.dietary[diet] = [];
                            categories.dietary[diet].push(recipe);
                        });
                    }
                });
                
                return categories;
            }

            viewRecipe(id) {
                const recipe = this.recipes.find(r => r.id === id);
                if (recipe) {
                    this.showRecipeModal(recipe);
                }
            }

            showRecipeModal(recipe) {
                document.getElementById('modalTitle').textContent = recipe.title;
                
                let content = '';
                
                // Add meta information
                if (recipe.servings || recipe.prepTime || recipe.cookTime) {
                    content += '<div style="margin-bottom: 25px; padding: 15px; background: var(--light-sage); border-radius: 10px; color: white;">';
                    if (recipe.servings) content += `<span style="margin-right: 20px;">${recipe.servings}</span>`;
                    if (recipe.prepTime) content += `<span style="margin-right: 20px;">${recipe.prepTime}</span>`;
                    if (recipe.cookTime) content += `<span>${recipe.cookTime}</span>`;
                    content += '</div>';
                }
                
                // Add ingredients
                if (recipe.ingredients.length > 0) {
                    content += '<h4>Ingredients</h4><ul>';
                    recipe.ingredients.forEach(ingredient => {
                        content += `<li>${ingredient}</li>`;
                    });
                    content += '</ul>';
                }
                
                // Add instructions
                if (recipe.instructions.length > 0) {
                    content += '<h4>Instructions</h4><ol>';
                    recipe.instructions.forEach(instruction => {
                        content += `<li>${instruction}</li>`;
                    });
                    content += '</ol>';
                }
                
                // If no structured data, show original content
                if (recipe.ingredients.length === 0 && recipe.instructions.length === 0) {
                    content += '<div style="white-space: pre-line;">' + recipe.content + '</div>';
                }
                
                document.getElementById('modalContent').innerHTML = content;
                document.getElementById('recipeModal').style.display = 'block';
            }

            closeModal() {
                document.getElementById('recipeModal').style.display = 'none';
            }

            handleSearch(query) {
                const filtered = query.trim() === '' ? this.recipes : 
                    this.recipes.filter(recipe => 
                        recipe.title.toLowerCase().includes(query.toLowerCase()) ||
                        recipe.content.toLowerCase().includes(query.toLowerCase()) ||
                        (recipe.type && recipe.type.toLowerCase().includes(query.toLowerCase())) ||
                        (recipe.mainIngredient && recipe.mainIngredient.toLowerCase().includes(query.toLowerCase())) ||
                        (recipe.cuisine && recipe.cuisine.toLowerCase().includes(query.toLowerCase())) ||
                        (recipe.dietary && recipe.dietary.some(d => d.toLowerCase().includes(query.toLowerCase())))
                    );
                this.renderRecipes(filtered);
            }

            getSelectedDietaryRestrictions() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                return Array.from(checkboxes).map(cb => cb.value);
            }

            applyFilters() {
                const filters = {
                    type: document.getElementById('filterType').value,
                    mainIngredient: document.getElementById('filterIngredient').value,
                    cuisine: document.getElementById('filterCuisine').value,
                    difficulty: document.getElementById('filterDifficulty').value,
                    cookTimeCategory: document.getElementById('filterTime').value,
                    dietary: document.getElementById('filterDietary').value
                };

                let filtered = this.recipes;

                // Apply each filter
                Object.keys(filters).forEach(key => {
                    if (filters[key]) {
                        if (key === 'dietary') {
                            filtered = filtered.filter(recipe => 
                                recipe.dietary && recipe.dietary.includes(filters[key])
                            );
                        } else {
                            filtered = filtered.filter(recipe => recipe[key] === filters[key]);
                        }
                    }
                });

                this.renderRecipes(filtered);
            }

            clearFilters() {
                // Reset all filter controls
                document.getElementById('filterType').value = '';
                document.getElementById('filterIngredient').value = '';
                document.getElementById('filterCuisine').value = '';
                document.getElementById('filterDifficulty').value = '';
                document.getElementById('filterTime').value = '';
                document.getElementById('filterDietary').value = '';
                document.getElementById('searchInput').value = '';

                // Show all recipes
                this.renderRecipes();
            }

            handleSort(sortBy) {
                let sorted = [...this.recipes];

                switch(sortBy) {
                    case 'newest':
                        sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        break;
                    case 'oldest':
                        sorted.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                        break;
                    case 'title-az':
                        sorted.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'title-za':
                        sorted.sort((a, b) => b.title.localeCompare(a.title));
                        break;
                    case 'difficulty-easy':
                        const difficultyOrder = { 'easy': 1, 'medium': 2, 'hard': 3 };
                        sorted.sort((a, b) => (difficultyOrder[a.difficulty] || 4) - (difficultyOrder[b.difficulty] || 4));
                        break;
                    case 'difficulty-hard':
                        const difficultyOrderRev = { 'hard': 1, 'medium': 2, 'easy': 3 };
                        sorted.sort((a, b) => (difficultyOrderRev[a.difficulty] || 4) - (difficultyOrderRev[b.difficulty] || 4));
                        break;
                    case 'time-short':
                        const timeOrder = { 'under-15': 1, '15-30': 2, '30-60': 3, '1-2-hours': 4, 'over-2-hours': 5 };
                        sorted.sort((a, b) => (timeOrder[a.cookTimeCategory] || 6) - (timeOrder[b.cookTimeCategory] || 6));
                        break;
                    case 'time-long':
                        const timeOrderRev = { 'over-2-hours': 1, '1-2-hours': 2, '30-60': 3, '15-30': 4, 'under-15': 5 };
                        sorted.sort((a, b) => (timeOrderRev[a.cookTimeCategory] || 6) - (timeOrderRev[b.cookTimeCategory] || 6));
                        break;
                }

                this.renderRecipes(sorted);
            }

            renderRecipes(recipesToRender = this.recipes) {
                const container = document.getElementById('recipesContainer');
                
                if (recipesToRender.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>${this.recipes.length === 0 ? 'Your Recipe Collection Awaits' : 'No Recipes Found'}</h3>
                            <p>${this.recipes.length === 0 ? 
                                'Start by adding your first recipe using the "Add Recipe" tab above.' : 
                                'Try adjusting your search terms.'}</p>
                        </div>
                    `;
                    return;
                }

                const recipesGrid = document.createElement('div');
                recipesGrid.className = 'recipes-grid';
                
                recipesToRender.forEach(recipe => {
                    const card = document.createElement('div');
                    card.className = 'recipe-card';
                    
                    const preview = recipe.content.substring(0, 150) + (recipe.content.length > 150 ? '...' : '');
                    
                    // Build category tags
                    const categoryTags = this.buildCategoryTags(recipe);
                    
                    card.innerHTML = `
                        <h3>${this.escapeHtml(recipe.title)}</h3>
                        <div class="recipe-categories">
                            ${categoryTags}
                        </div>
                        <div class="recipe-meta">
                            ${recipe.servings ? `<span>${this.escapeHtml(recipe.servings)}</span>` : ''}
                            ${recipe.prepTime ? `<span>${this.escapeHtml(recipe.prepTime)}</span>` : ''}
                            ${recipe.cookTime ? `<span>${this.escapeHtml(recipe.cookTime)}</span>` : ''}
                        </div>
                        <div class="recipe-preview">${this.escapeHtml(preview)}</div>
                        <div class="recipe-actions">
                            <button class="btn-small btn-edit" data-action="view" data-id="${recipe.id}">View</button>
                            <button class="btn-small btn-edit" data-action="edit" data-id="${recipe.id}">Edit</button>
                            <button class="btn-small btn-delete" data-action="delete" data-id="${recipe.id}">Delete</button>
                        </div>
                    `;
                    
                    // Add event listeners for buttons
                    const viewBtn = card.querySelector('[data-action="view"]');
                    const editBtn = card.querySelector('[data-action="edit"]');
                    const deleteBtn = card.querySelector('[data-action="delete"]');
                    
                    viewBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.viewRecipe(recipe.id);
                    });
                    
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.editRecipe(recipe.id);
                    });
                    
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteRecipe(recipe.id);
                    });
                    
                    // Make card clickable to view recipe
                    card.style.cursor = 'pointer';
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('.recipe-actions')) {
                            this.viewRecipe(recipe.id);
                        }
                    });
                    
                    recipesGrid.appendChild(card);
                });
                
                container.innerHTML = '';
                container.appendChild(recipesGrid);
            }

            resetForm() {
                document.getElementById('recipeForm').reset();
                // Clear all checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                this.currentEditId = null;
            }

            loadRecipes() {
                const saved = localStorage.getItem('recipe-keeper-recipes');
                return saved ? JSON.parse(saved) : [];
            }

            saveRecipes() {
                localStorage.setItem('recipe-keeper-recipes', JSON.stringify(this.recipes));
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showLoading(message = 'Processing...') {
                const existingLoader = document.getElementById('loading-overlay');
                if (existingLoader) return;

                const loader = document.createElement('div');
                loader.id = 'loading-overlay';
                loader.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--warm-white); padding: 30px; border-radius: 15px; box-shadow: 0 8px 32px var(--shadow); text-align: center;">
                            <div style="width: 40px; height: 40px; border: 3px solid var(--light-sage); border-top: 3px solid var(--sage); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto;"></div>
                            <p style="color: var(--deep-sage); font-family: 'Crimson Text', serif; font-size: 1.1rem;">${message}</p>
                        </div>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                document.body.appendChild(loader);
            }

            hideLoading() {
                const loader = document.getElementById('loading-overlay');
                if (loader) {
                    loader.remove();
                }
            }

            showBackupOptions() {
                const modal = document.createElement('div');
                modal.id = 'backup-modal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--warm-white); padding: 40px; border-radius: 20px; box-shadow: 0 8px 32px var(--shadow); max-width: 500px; width: 90%; text-align: center;">
                            <h3 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; margin-bottom: 20px; font-size: 1.8rem;">Recipe Backup & Restore</h3>
                            <p style="color: var(--soft-brown); margin-bottom: 30px; font-size: 1.1rem;">Keep your recipes safe with backup and restore options.</p>
                            
                            <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px;">
                                <button id="export-recipes" style="background: var(--sage); color: white; border: none; padding: 15px 20px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1.1rem; cursor: pointer;">
                                    üì• Export All Recipes
                                </button>
                                <label for="import-file" style="background: var(--light-sage); color: white; border: none; padding: 15px 20px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1.1rem; cursor: pointer; display: block;">
                                    üì§ Import Recipes from File
                                </label>
                                <input type="file" id="import-file" accept=".json" style="display: none;">
                                <button id="clear-all-data" style="background: var(--terracotta); color: white; border: none; padding: 15px 20px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1.1rem; cursor: pointer;">
                                    üóëÔ∏è Clear All Data
                                </button>
                            </div>
                            
                            <div style="margin-bottom: 20px; padding: 15px; background: var(--light-sage); border-radius: 10px; color: white; font-size: 0.9rem;">
                                <strong>üìä Current Status:</strong><br>
                                <span id="recipe-count">${this.recipes.length} recipes stored</span><br>
                                <span id="storage-info">Checking storage...</span>
                            </div>
                            
                            <button id="close-backup" style="background: var(--soft-brown); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1rem; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Update storage info
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    navigator.storage.estimate().then(estimate => {
                        const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                        const quotaMB = (estimate.quota / 1024 / 1024).toFixed(2);
                        document.getElementById('storage-info').textContent = `${usedMB}MB used of ${quotaMB}MB available`;
                    });
                }

                // Event listeners
                document.getElementById('export-recipes').addEventListener('click', () => this.exportRecipes());
                document.getElementById('import-file').addEventListener('change', (e) => this.importRecipes(e));
                document.getElementById('clear-all-data').addEventListener('click', () => this.clearAllData());
                document.getElementById('close-backup').addEventListener('click', () => modal.remove());
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            exportRecipes() {
                const backup = {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    recipeCount: this.recipes.length,
                    recipes: this.recipes
                };

                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `recipe-keeper-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(link.href);
                
                // Show success message
                this.showMessage('‚úÖ Recipes exported successfully!', 'success');
            }

            importRecipes(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (!backup.recipes || !Array.isArray(backup.recipes)) {
                            throw new Error('Invalid backup file format');
                        }

                        // Merge with existing recipes (avoid duplicates by ID)
                        const existingIds = new Set(this.recipes.map(r => r.id));
                        const newRecipes = backup.recipes.filter(r => !existingIds.has(r.id));
                        
                        this.recipes.push(...newRecipes);
                        this.saveRecipes();
                        this.renderRecipes();
                        
                        document.getElementById('backup-modal').remove();
                        this.showMessage(`‚úÖ Imported ${newRecipes.length} new recipes!`, 'success');
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        this.showMessage('‚ùå Error importing recipes. Please check the file format.', 'error');
                    }
                };
                reader.readAsText(file);
            }

            clearAllData() {
                if (confirm(`‚ö†Ô∏è Are you sure you want to delete ALL ${this.recipes.length} recipes?\n\nThis action cannot be undone. Consider exporting your recipes first.`)) {
                    localStorage.removeItem('recipe-keeper-recipes');
                    this.recipes = [];
                    this.renderRecipes();
                    document.getElementById('backup-modal').remove();
                    this.showMessage('üóëÔ∏è All recipe data cleared.', 'info');
                }
            }

            showMessage(message, type = 'info') {
                const colors = {
                    success: 'var(--sage)',
                    error: 'var(--terracotta)',
                    info: 'var(--soft-brown)'
                };

                const messageDiv = document.createElement('div');
                messageDiv.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; font-family: 'Crimson Text', serif;">
                        ${message}
                    </div>
                `;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 4000);
            }
        }

        // Initialize the app
        const recipeKeeper = new RecipeKeeper();

        // Request persistent storage for better data retention
        if ('storage' in navigator && 'persist' in navigator.storage) {
            navigator.storage.persist().then(persistent => {
                if (persistent) {
                    console.log('‚úÖ Persistent storage granted - recipes will be protected from automatic cleanup');
                } else {
                    console.log('‚ö†Ô∏è Persistent storage not granted - recipes may be cleared under storage pressure');
                }
            });
        }

        // Monitor storage usage
        if ('storage' in navigator && 'estimate' in navigator.storage) {
            navigator.storage.estimate().then(estimate => {
                const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                const quotaMB = (estimate.quota / 1024 / 1024).toFixed(2);
                console.log(`üìä Storage: ${usedMB}MB used of ${quotaMB}MB available`);
            });
        }

        // PWA Installation and Service Worker
        class PWAManager {
            constructor() {
                this.deferredPrompt = null;
                this.installButton = null;
                this.initializePWA();
            }

            async initializePWA() {
                // Register service worker
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.log('Service Worker registered:', registration.scope);
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    this.showUpdateNotification();
                                }
                            });
                        });
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }

                // Handle PWA install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallButton();
                });

                // Handle PWA install success
                window.addEventListener('appinstalled', () => {
                    console.log('PWA installed successfully');
                    this.hideInstallButton();
                    this.showInstallSuccessMessage();
                });

                // Check if already installed
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                    console.log('App is running as PWA');
                    document.body.classList.add('pwa-installed');
                }
            }

            showInstallButton() {
                if (this.installButton) return;

                this.installButton = document.createElement('button');
                this.installButton.className = 'nav-btn install-btn';
                this.installButton.innerHTML = 'üì± Install App';
                this.installButton.style.background = 'var(--terracotta)';
                this.installButton.addEventListener('click', () => this.installPWA());

                const nav = document.querySelector('.main-nav');
                nav.appendChild(this.installButton);
            }

            hideInstallButton() {
                if (this.installButton) {
                    this.installButton.remove();
                    this.installButton = null;
                }
            }

            async installPWA() {
                if (!this.deferredPrompt) return;

                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                
                console.log('Install prompt outcome:', outcome);
                this.deferredPrompt = null;
                
                if (outcome === 'dismissed') {
                    this.hideInstallButton();
                }
            }

            showUpdateNotification() {
                const notification = document.createElement('div');
                notification.className = 'update-notification';
                notification.innerHTML = `
                    <div style="background: var(--sage); color: white; padding: 15px; border-radius: 10px; margin: 20px; text-align: center; box-shadow: 0 4px 15px rgba(156, 175, 136, 0.3);">
                        <p style="margin-bottom: 10px;">A new version is available!</p>
                        <button onclick="this.parentElement.parentElement.remove(); location.reload();" 
                                style="background: white; color: var(--sage); border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-family: 'Crimson Text', serif;">
                            Update Now
                        </button>
                        <button onclick="this.parentElement.parentElement.remove();" 
                                style="background: transparent; color: white; border: 1px solid white; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-left: 10px; font-family: 'Crimson Text', serif;">
                            Later
                        </button>
                    </div>
                `;
                
                document.body.insertBefore(notification, document.body.firstChild);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 10000);
            }

            showInstallSuccessMessage() {
                const message = document.createElement('div');
                message.innerHTML = `
                    <div style="background: var(--sage); color: white; padding: 15px; border-radius: 10px; margin: 20px; text-align: center; box-shadow: 0 4px 15px rgba(156, 175, 136, 0.3);">
                        <p>üéâ App installed successfully! You can now use Recipe Keeper offline.</p>
                    </div>
                `;
                
                document.body.insertBefore(message, document.body.firstChild);
                
                setTimeout(() => {
                    if (message.parentElement) {
                        message.remove();
                    }
                }, 5000);
            }
        }

        // Initialize PWA functionality
        const pwaManager = new PWAManager();

        // Handle deep links for PWA shortcuts
        window.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash === '#add') {
                recipeKeeper.switchSection('import');
            } else if (hash === '#recipes') {
                recipeKeeper.switchSection('recipes');
            }
        });
    </script>
</body>
</html>