<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Keeper</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="A beautiful, rustic recipe keeper app for storing and organizing your favorite recipes">
    <meta name="theme-color" content="#9caf88">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Recipe Keeper">
    <meta name="msapplication-TileColor" content="#9caf88">
    <meta name="msapplication-TileImage" content="icon-192.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-apple-touch.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cream: #faf7f2;
            --warm-white: #f8f5f0;
            --sage: #9caf88;
            --deep-sage: #7a8b6b;
            --terracotta: #c17b5c;
            --soft-brown: #8b6f47;
            --charcoal: #3a3a3a;
            --light-sage: #b8c9a8;
            --shadow: rgba(0, 0, 0, 0.1);
            --soft-shadow: rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--warm-white) 100%);
            min-height: 100vh;
            color: var(--charcoal);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: var(--warm-white);
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
        }

        .header h1 {
            font-family: 'Libre Baskerville', serif;
            font-size: 3.2rem;
            color: var(--deep-sage);
            margin-bottom: 10px;
            text-shadow: 0 2px 4px var(--soft-shadow);
        }

        .header p {
            font-size: 1.2rem;
            color: var(--soft-brown);
            font-style: italic;
        }

        .main-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: var(--sage);
            color: white;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 175, 136, 0.3);
        }

        .nav-btn:hover {
            background: var(--deep-sage);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 175, 136, 0.4);
        }

        .nav-btn.active {
            background: var(--terracotta);
            box-shadow: 0 4px 15px rgba(193, 123, 92, 0.3);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .import-section {
            background: var(--warm-white);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
        }

        .import-section h2 {
            font-family: 'Libre Baskerville', serif;
            color: var(--deep-sage);
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--soft-brown);
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--light-sage);
            border-radius: 10px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            background: var(--cream);
            transition: border-color 0.3s ease;
            resize: vertical;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(156, 175, 136, 0.1);
        }

        .btn-primary {
            background: var(--sage);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 175, 136, 0.3);
        }

        .btn-primary:hover {
            background: var(--deep-sage);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 175, 136, 0.4);
        }

        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .recipe-card {
            background: var(--warm-white);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px var(--shadow);
        }

        .recipe-card h3 {
            font-family: 'Libre Baskerville', serif;
            color: var(--deep-sage);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .recipe-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--soft-brown);
        }

        .recipe-meta span {
            background: var(--light-sage);
            padding: 4px 12px;
            border-radius: 15px;
            color: white;
        }

        .recipe-preview {
            color: var(--charcoal);
            font-size: 1rem;
            line-height: 1.5;
        }

        .recipe-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 15px;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: var(--sage);
            color: white;
        }

        .btn-delete {
            background: var(--terracotta);
            color: white;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .search-bar {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 30px auto;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--light-sage);
            border-radius: 25px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            background: var(--cream);
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(156, 175, 136, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--warm-white);
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-sage);
        }

        .modal-title {
            font-family: 'Libre Baskerville', serif;
            font-size: 2rem;
            color: var(--deep-sage);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--soft-brown);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .close-btn:hover {
            background: var(--light-sage);
            color: white;
        }

        .recipe-detail {
            font-size: 1.1rem;
            line-height: 1.7;
        }

        .recipe-detail h4 {
            font-family: 'Libre Baskerville', serif;
            color: var(--deep-sage);
            margin: 25px 0 15px 0;
            font-size: 1.3rem;
        }

        .recipe-detail ul, .recipe-detail ol {
            margin-left: 20px;
            margin-bottom: 20px;
        }

        .recipe-detail li {
            margin-bottom: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--soft-brown);
        }

        .empty-state h3 {
            font-family: 'Libre Baskerville', serif;
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--deep-sage);
        }

        .empty-state p {
            font-size: 1.2rem;
            font-style: italic;
        }

        /* Category Section Styles */
        .category-section {
            background: var(--cream);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border: 1px solid rgba(156, 175, 136, 0.2);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--soft-brown);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .checkbox-label:hover {
            background: var(--light-sage);
            color: white;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        /* Filter Section Styles */
        .filter-section {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: var(--soft-brown);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .filter-control {
            padding: 10px;
            border: 2px solid var(--light-sage);
            border-radius: 8px;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            background: var(--cream);
            transition: border-color 0.3s ease;
        }

        .filter-control:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(156, 175, 136, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-filter {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-apply {
            background: var(--sage);
            color: white;
        }

        .btn-clear {
            background: var(--light-sage);
            color: white;
        }

        .btn-filter:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Recipe Card Category Tags */
        .recipe-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .category-tag {
            background: var(--light-sage);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .category-tag.type { background: var(--sage); }
        .category-tag.ingredient { background: var(--terracotta); }
        .category-tag.cuisine { background: var(--soft-brown); }
        .category-tag.difficulty { background: var(--deep-sage); }
        .category-tag.time { background: #8b6f47; }
        .category-tag.dietary { background: #7a8b6b; }

        /* Sort Options */
        .sort-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sort-label {
            color: var(--soft-brown);
            font-weight: 600;
            font-size: 1rem;
        }

        .sort-select {
            padding: 8px 15px;
            border: 2px solid var(--light-sage);
            border-radius: 8px;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            background: var(--cream);
            color: var(--charcoal);
        }

        /* Categories Section Styles */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .category-card {
            background: var(--warm-white);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px var(--shadow);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-name {
            font-family: 'Libre Baskerville', serif;
            font-size: 1.3rem;
            color: var(--deep-sage);
            font-weight: 600;
        }

        .category-count {
            background: var(--sage);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .category-recipes {
            margin-top: 15px;
        }

        .category-recipe-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-sage);
        }

        .category-recipe-item:last-child {
            border-bottom: none;
        }

        .category-recipe-title {
            color: var(--charcoal);
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .category-recipe-title:hover {
            color: var(--deep-sage);
        }

        .category-recipe-actions {
            display: flex;
            gap: 5px;
        }

        .btn-tiny {
            padding: 4px 8px;
            border: none;
            border-radius: 8px;
            font-family: 'Crimson Text', serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view {
            background: var(--sage);
            color: white;
        }

        .btn-edit {
            background: var(--light-sage);
            color: white;
        }

        .btn-tiny:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Rating System Styles */
        .rating-container {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }

        .star-rating {
            display: flex;
            gap: 2px;
        }

        .star {
            font-size: 1.5rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s ease;
            user-select: none;
        }

        .star:hover,
        .star.active {
            color: #ffd700;
        }

        .star:hover ~ .star {
            color: #ddd;
        }

        /* Nutrition Grid */
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        /* Photo Preview */
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--soft-shadow);
            margin: 10px auto;
        }

        /* Recipe Card Enhancements */
        .recipe-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .recipe-rating .stars {
            color: #ffd700;
            font-size: 1rem;
        }

        .recipe-favorite {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.2rem;
            color: #ffd700;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .recipe-favorite:hover {
            transform: scale(1.2);
        }

        .recipe-photo {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .recipe-video {
            background: var(--terracotta);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        /* Cooking Mode Styles */
        .cooking-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--warm-white);
            z-index: 2000;
            overflow-y: auto;
            font-size: 1.2rem;
        }

        .cooking-header {
            background: var(--sage);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 2001;
        }

        .cooking-content {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--light-sage);
        }

        .ingredient-checkbox {
            margin-right: 15px;
            transform: scale(1.2);
        }

        .ingredient-checked {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .step-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--light-sage);
        }

        .step-current {
            background: var(--light-sage);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .cooking-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--sage);
            padding: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-cooking {
            background: white;
            color: var(--sage);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cooking:hover {
            background: var(--light-sage);
            color: white;
        }

        /* Shopping List Styles */
        .shopping-list {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
        }

        .aisle-group {
            margin-bottom: 20px;
        }

        .aisle-title {
            font-family: 'Libre Baskerville', serif;
            color: var(--deep-sage);
            font-size: 1.2rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--light-sage);
        }

        .shopping-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-sage);
        }

        .shopping-checkbox {
            margin-right: 15px;
            transform: scale(1.1);
        }

        .shopping-checked {
            text-decoration: line-through;
            opacity: 0.6;
        }

        /* Text Size Controls */
        .text-size-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--sage);
            color: white;
            padding: 10px;
            border-radius: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1000;
        }

        .text-size-btn {
            background: white;
            color: var(--sage);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Crimson Text', serif;
        }

        /* Social Media Styles */
        .social-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .social-card {
            background: var(--warm-white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
            text-align: center;
        }

        .social-card h3 {
            color: var(--deep-sage);
            font-family: 'Libre Baskerville', serif;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .social-card p {
            color: var(--soft-brown);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .social-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .import-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .file-import {
            margin-top: 10px;
        }

        .quick-share-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .btn-social {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-social.facebook {
            background: #1877f2;
            color: white;
        }

        .btn-social.twitter {
            background: #1da1f2;
            color: white;
        }

        .btn-social.whatsapp {
            background: #25d366;
            color: white;
        }

        .btn-social.email {
            background: var(--terracotta);
            color: white;
        }

        .btn-social:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Share Modal Styles */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .share-modal-content {
            background: var(--warm-white);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .share-option {
            padding: 15px;
            border: 2px solid var(--light-sage);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-option:hover {
            background: var(--light-sage);
            color: white;
        }

        .share-option.selected {
            background: var(--sage);
            color: white;
            border-color: var(--sage);
        }

        .qr-code-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid var(--light-sage);
        }

        .share-url {
            background: var(--light-sage);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
        }

        /* Shopping List Styles */
        .shopping-controls {
            background: var(--warm-white);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
        }

        .shopping-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .shopping-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .shopping-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--soft-brown);
            font-family: 'Crimson Text', serif;
            cursor: pointer;
        }

        .shopping-options input[type="checkbox"] {
            transform: scale(1.2);
        }

        .aisle-group {
            margin-bottom: 25px;
            background: var(--warm-white);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--soft-shadow);
            border: 1px solid rgba(156, 175, 136, 0.1);
        }

        .aisle-title {
            background: var(--sage);
            color: white;
            padding: 15px 20px;
            font-family: 'Libre Baskerville', serif;
            font-size: 1.2rem;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .aisle-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .shopping-items {
            padding: 0;
        }

        .shopping-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-sage);
            transition: all 0.3s ease;
        }

        .shopping-item:last-child {
            border-bottom: none;
        }

        .shopping-item:hover {
            background: rgba(156, 175, 136, 0.05);
        }

        .shopping-checkbox {
            margin-right: 15px;
            transform: scale(1.3);
            cursor: pointer;
        }

        .shopping-item-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shopping-item-name {
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            color: var(--deep-sage);
        }

        .shopping-item-quantity {
            color: var(--soft-brown);
            font-style: italic;
            margin-left: 10px;
        }

        .shopping-item-actions {
            display: flex;
            gap: 10px;
        }

        .btn-item-action {
            background: none;
            border: none;
            color: var(--soft-brown);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .btn-item-action:hover {
            background: var(--light-sage);
            color: white;
        }

        .shopping-item.completed {
            opacity: 0.6;
        }

        .shopping-item.completed .shopping-item-name {
            text-decoration: line-through;
        }

        .shopping-summary {
            background: var(--light-sage);
            padding: 15px 20px;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Crimson Text', serif;
            color: var(--deep-sage);
        }

        .shopping-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--sage);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--soft-brown);
        }

        /* Custom Item Modal Styles */
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px;
            border-top: 1px solid var(--light-sage);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--light-sage);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--soft-brown);
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--sage);
        }

        /* Recipe Selection Modal */
        .recipe-selection-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .recipe-selection-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--light-sage);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recipe-selection-item:hover {
            background: var(--light-sage);
            color: white;
        }

        .recipe-selection-item input[type="checkbox"] {
            margin-right: 15px;
            transform: scale(1.2);
        }

        .recipe-info {
            flex: 1;
        }

        .recipe-info strong {
            display: block;
            margin-bottom: 5px;
        }

        .recipe-meta {
            font-size: 0.9rem;
            color: var(--soft-brown);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s ease;
        }

        /* Rich Text Editor Styles */
        .rich-text-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: var(--light-sage);
            border: 1px solid var(--sage);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            flex-wrap: wrap;
        }

        .format-btn {
            background: white;
            border: 1px solid var(--sage);
            color: var(--sage);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Crimson Text', serif;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 35px;
        }

        .format-btn:hover {
            background: var(--sage);
            color: white;
        }

        .format-btn.active {
            background: var(--sage);
            color: white;
        }

        .rich-text-editor {
            min-height: 200px;
            padding: 15px;
            border: 1px solid var(--sage);
            border-top: none;
            border-radius: 0 0 10px 10px;
            background: white;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
        }

        .rich-text-editor:empty:before {
            content: attr(data-placeholder);
            color: var(--soft-brown);
            font-style: italic;
        }

        .rich-text-editor:focus {
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(156, 175, 136, 0.1);
        }

        .rich-text-editor p {
            margin: 0 0 10px 0;
        }

        .rich-text-editor ul, .rich-text-editor ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .rich-text-editor li {
            margin: 5px 0;
        }

        .rich-text-editor strong, .rich-text-editor b {
            font-weight: bold;
        }

        .rich-text-editor em, .rich-text-editor i {
            font-style: italic;
        }

        .rich-text-editor u {
            text-decoration: underline;
        }

        .rich-text-editor h1, .rich-text-editor h2, .rich-text-editor h3 {
            font-family: 'Libre Baskerville', serif;
            color: var(--deep-sage);
            margin: 15px 0 10px 0;
        }

        .rich-text-editor h1 {
            font-size: 1.5rem;
        }

        .rich-text-editor h2 {
            font-size: 1.3rem;
        }

        .rich-text-editor h3 {
            font-size: 1.1rem;
        }

        /* Recipe Display with Rich Text */
        .recipe-content {
            font-family: 'Crimson Text', serif;
            line-height: 1.6;
            color: var(--deep-sage);
        }

        .recipe-content p {
            margin: 0 0 15px 0;
        }

        .recipe-content ul, .recipe-content ol {
            margin: 15px 0;
            padding-left: 20px;
        }

        .recipe-content li {
            margin: 8px 0;
        }

        .recipe-content strong, .recipe-content b {
            font-weight: bold;
            color: var(--sage);
        }

        .recipe-content em, .recipe-content i {
            font-style: italic;
        }

        .recipe-content u {
            text-decoration: underline;
        }

        .recipe-content h1, .recipe-content h2, .recipe-content h3 {
            font-family: 'Libre Baskerville', serif;
            color: var(--deep-sage);
            margin: 20px 0 15px 0;
        }

        .recipe-content h1 {
            font-size: 1.5rem;
        }

        .recipe-content h2 {
            font-size: 1.3rem;
        }

        .recipe-content h3 {
            font-size: 1.1rem;
        }

        /* Unit Conversion Styles */
        .toolbar-separator {
            width: 1px;
            height: 30px;
            background: var(--sage);
            margin: 0 10px;
        }

        .conversion-btn {
            background: var(--terracotta) !important;
            color: white !important;
        }

        .conversion-btn:hover {
            background: var(--sage) !important;
        }

        .conversion-options {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .conversion-option {
            flex: 1;
        }

        .conversion-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid var(--light-sage);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Crimson Text', serif;
        }

        .conversion-option label:hover {
            background: var(--light-sage);
            color: white;
        }

        .conversion-option input[type="radio"] {
            transform: scale(1.2);
        }

        .conversion-option input[type="radio"]:checked + label {
            background: var(--sage);
            color: white;
            border-color: var(--sage);
        }

        .conversion-preview {
            margin: 20px 0;
            padding: 15px;
            background: var(--warm-white);
            border-radius: 10px;
            border: 1px solid var(--light-sage);
        }

        .conversion-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .conversion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--light-sage);
            font-family: 'Crimson Text', serif;
        }

        .conversion-item:last-child {
            border-bottom: none;
        }

        .conversion-original {
            color: var(--soft-brown);
            text-decoration: line-through;
        }

        .conversion-arrow {
            margin: 0 10px;
            color: var(--sage);
            font-weight: bold;
        }

        .conversion-result {
            color: var(--deep-sage);
            font-weight: bold;
        }

        .conversion-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Import Divider */
        .import-divider {
            text-align: center;
            margin: 15px 0;
            position: relative;
        }

        .import-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--light-sage);
        }

        .import-divider span {
            background: var(--warm-white);
            padding: 0 15px;
            color: var(--soft-brown);
            font-style: italic;
        }

        /* OCR Scanning Styles */
        .ocr-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .camera-option {
            margin-top: 10px;
        }

        .ocr-interface {
            text-align: center;
        }

        .camera-container {
            margin: 20px 0;
        }

        .camera-controls, .image-controls, .ocr-actions {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .image-preview {
            margin: 20px 0;
        }

        .ocr-results {
            text-align: left;
            margin: 20px 0;
        }

        .ocr-results textarea {
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Website Import Styles */
        .import-status {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-sage);
            border-top: 4px solid var(--sage);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .import-results {
            text-align: left;
        }

        .imported-recipe-preview {
            background: var(--warm-white);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid var(--light-sage);
        }

        .imported-recipe-preview h5 {
            color: var(--deep-sage);
            font-family: 'Libre Baskerville', serif;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .import-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Camera and Image Styles */
        #cameraVideo, #previewImage {
            box-shadow: 0 4px 15px var(--soft-shadow);
        }

        .camera-controls button, .image-controls button, .ocr-actions button {
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .recipes-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .recipe-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Recipe Keeper</h1>
            <p>Gather your favorite recipes in one cozy place</p>
        </header>

        <nav class="main-nav">
            <button class="nav-btn active" data-section="import">Add Recipe</button>
            <button class="nav-btn" data-section="recipes">My Recipes</button>
            <button class="nav-btn" data-section="categories">Categories</button>
            <button class="nav-btn" data-section="shopping">üõí Shopping</button>
            <button class="nav-btn" data-section="social">üì± Share & Import</button>
            <button class="nav-btn" onclick="recipeKeeper.showBackupOptions()">‚öôÔ∏è Backup</button>
        </nav>

        <!-- Import Recipe Section -->
        <section id="import" class="section active">
            <div class="import-section">
                <h2>Add a New Recipe</h2>
                <p style="margin-bottom: 25px; color: var(--soft-brown); font-style: italic;">
                    Simply paste your recipe text below, and I'll help organize it beautifully for you.
                </p>
                
                <form id="recipeForm">
                    <div class="form-group">
                        <label for="recipeTitle">Recipe Title</label>
                        <input type="text" id="recipeTitle" class="form-control" placeholder="Enter a title for your recipe" required>
                    </div>

                    <div class="form-group">
                        <label for="recipeText">Recipe Content</label>
                        <div class="rich-text-toolbar">
                            <button type="button" class="format-btn" data-command="bold" title="Bold">B</button>
                            <button type="button" class="format-btn" data-command="italic" title="Italic">I</button>
                            <button type="button" class="format-btn" data-command="underline" title="Underline">U</button>
                            <button type="button" class="format-btn" data-command="insertUnorderedList" title="Bullet List">‚Ä¢</button>
                            <button type="button" class="format-btn" data-command="insertOrderedList" title="Numbered List">1.</button>
                            <button type="button" class="format-btn" data-command="justifyLeft" title="Align Left">‚¨Ö</button>
                            <button type="button" class="format-btn" data-command="justifyCenter" title="Center">‚Üî</button>
                            <button type="button" class="format-btn" data-command="justifyRight" title="Align Right">‚û°</button>
                            <button type="button" class="format-btn" data-command="removeFormat" title="Clear Formatting">Clear</button>
                            <div class="toolbar-separator"></div>
                            <button type="button" class="format-btn conversion-btn" onclick="recipeKeeper.convertUnits()" title="Convert Units">üîÑ Convert Units</button>
                        </div>
                        <div id="recipeText" class="rich-text-editor" contenteditable="true" data-placeholder="Paste your recipe here... Include ingredients, instructions, cooking times, etc. I'll help organize it!"></div>
                    </div>

                    <!-- Category Selection Section -->
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; font-size: 1.3rem; margin: 0;">Recipe Categories</h3>
                            <button type="button" id="autoDetectBtn" class="btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">
                                ü§ñ Auto-Detect
                            </button>
                        </div>
                        
                        <div class="category-grid">
                            <div class="form-group">
                                <label for="recipeType">Recipe Type</label>
                                <select id="recipeType" class="form-control">
                                    <option value="">Select type...</option>
                                    <option value="appetizer">Appetizer</option>
                                    <option value="main-course">Main Course</option>
                                    <option value="side-dish">Side Dish</option>
                                    <option value="dessert">Dessert</option>
                                    <option value="breakfast">Breakfast</option>
                                    <option value="lunch">Lunch</option>
                                    <option value="dinner">Dinner</option>
                                    <option value="snack">Snack</option>
                                    <option value="beverage">Beverage</option>
                                    <option value="soup">Soup</option>
                                    <option value="salad">Salad</option>
                                    <option value="sauce">Sauce</option>
                                    <option value="bread">Bread</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="mainIngredient">Main Ingredient</label>
                                <select id="mainIngredient" class="form-control">
                                    <option value="">Select main ingredient...</option>
                                    <option value="chicken">Chicken</option>
                                    <option value="beef">Beef</option>
                                    <option value="pork">Pork</option>
                                    <option value="fish">Fish</option>
                                    <option value="seafood">Seafood</option>
                                    <option value="vegetables">Vegetables</option>
                                    <option value="pasta">Pasta</option>
                                    <option value="rice">Rice</option>
                                    <option value="potatoes">Potatoes</option>
                                    <option value="eggs">Eggs</option>
                                    <option value="cheese">Cheese</option>
                                    <option value="beans">Beans/Legumes</option>
                                    <option value="nuts">Nuts</option>
                                    <option value="fruits">Fruits</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="cuisine">Cuisine</label>
                                <select id="cuisine" class="form-control">
                                    <option value="">Select cuisine...</option>
                                    <option value="american">American</option>
                                    <option value="italian">Italian</option>
                                    <option value="mexican">Mexican</option>
                                    <option value="chinese">Chinese</option>
                                    <option value="indian">Indian</option>
                                    <option value="french">French</option>
                                    <option value="thai">Thai</option>
                                    <option value="japanese">Japanese</option>
                                    <option value="mediterranean">Mediterranean</option>
                                    <option value="middle-eastern">Middle Eastern</option>
                                    <option value="korean">Korean</option>
                                    <option value="greek">Greek</option>
                                    <option value="spanish">Spanish</option>
                                    <option value="german">German</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="difficulty">Difficulty</label>
                                <select id="difficulty" class="form-control">
                                    <option value="">Select difficulty...</option>
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="cookTime">Cooking Time</label>
                                <select id="cookTime" class="form-control">
                                    <option value="">Select time...</option>
                                    <option value="under-15">Under 15 minutes</option>
                                    <option value="15-30">15-30 minutes</option>
                                    <option value="30-60">30-60 minutes</option>
                                    <option value="1-2-hours">1-2 hours</option>
                                    <option value="over-2-hours">Over 2 hours</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="dietary">Dietary Restrictions</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="vegetarian"> Vegetarian
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="vegan"> Vegan
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="gluten-free"> Gluten-Free
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="dairy-free"> Dairy-Free
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="keto"> Keto
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="paleo"> Paleo
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Features Section -->
                    <div class="category-section">
                        <h3 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; margin-bottom: 20px; font-size: 1.3rem;">Additional Features</h3>
                        
                        <div class="category-grid">
                            <div class="form-group">
                                <label for="recipePhoto">Recipe Photo</label>
                                <input type="file" id="recipePhoto" class="form-control" accept="image/*">
                                <div id="photoPreview" style="margin-top: 10px; text-align: center;"></div>
                            </div>

                            <div class="form-group">
                                <label for="recipeRating">Rating</label>
                                <div class="rating-container">
                                    <div class="star-rating" id="starRating">
                                        <span class="star" data-rating="1">‚òÖ</span>
                                        <span class="star" data-rating="2">‚òÖ</span>
                                        <span class="star" data-rating="3">‚òÖ</span>
                                        <span class="star" data-rating="4">‚òÖ</span>
                                        <span class="star" data-rating="5">‚òÖ</span>
                                    </div>
                                    <span id="ratingText" style="margin-left: 10px; color: var(--soft-brown);">No rating</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="isFavorite">
                                    <input type="checkbox" id="isFavorite" style="margin-right: 8px;">
                                    ‚≠ê Mark as Favorite
                                </label>
                            </div>

                            <div class="form-group">
                                <label for="videoUrl">Video URL (YouTube, etc.)</label>
                                <input type="url" id="videoUrl" class="form-control" placeholder="https://youtube.com/watch?v=...">
                            </div>

                            <div class="form-group">
                                <label for="recipeNotes">Notes</label>
                                <textarea id="recipeNotes" class="form-control" rows="3" placeholder="Personal notes, variations, tips..."></textarea>
                            </div>
                        </div>

                        <!-- Nutrition Information -->
                        <div style="margin-top: 25px;">
                            <h4 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; margin-bottom: 15px;">Nutrition Information (Optional)</h4>
                            <div class="nutrition-grid">
                                <div class="form-group">
                                    <label for="calories">Calories</label>
                                    <input type="number" id="calories" class="form-control" placeholder="per serving">
                                </div>
                                <div class="form-group">
                                    <label for="protein">Protein (g)</label>
                                    <input type="number" id="protein" class="form-control" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="carbs">Carbs (g)</label>
                                    <input type="number" id="carbs" class="form-control" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="fat">Fat (g)</label>
                                    <input type="number" id="fat" class="form-control" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="fiber">Fiber (g)</label>
                                    <input type="number" id="fiber" class="form-control" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="sugar">Sugar (g)</label>
                                    <input type="number" id="sugar" class="form-control" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="sodium">Sodium (mg)</label>
                                    <input type="number" id="sodium" class="form-control" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">Save Recipe</button>
                </form>
            </div>
        </section>

        <!-- Recipes List Section -->
        <section id="recipes" class="section">
            <div class="search-bar">
                <input type="text" id="searchInput" class="search-input" placeholder="Search your recipes...">
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <h3 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; margin-bottom: 20px; font-size: 1.3rem;">Filter & Sort Recipes</h3>
                
                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="filterType">Recipe Type</label>
                        <select id="filterType" class="filter-control">
                            <option value="">All Types</option>
                            <option value="appetizer">Appetizer</option>
                            <option value="main-course">Main Course</option>
                            <option value="side-dish">Side Dish</option>
                            <option value="dessert">Dessert</option>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                            <option value="beverage">Beverage</option>
                            <option value="soup">Soup</option>
                            <option value="salad">Salad</option>
                            <option value="sauce">Sauce</option>
                            <option value="bread">Bread</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterIngredient">Main Ingredient</label>
                        <select id="filterIngredient" class="filter-control">
                            <option value="">All Ingredients</option>
                            <option value="chicken">Chicken</option>
                            <option value="beef">Beef</option>
                            <option value="pork">Pork</option>
                            <option value="fish">Fish</option>
                            <option value="seafood">Seafood</option>
                            <option value="vegetables">Vegetables</option>
                            <option value="pasta">Pasta</option>
                            <option value="rice">Rice</option>
                            <option value="potatoes">Potatoes</option>
                            <option value="eggs">Eggs</option>
                            <option value="cheese">Cheese</option>
                            <option value="beans">Beans/Legumes</option>
                            <option value="nuts">Nuts</option>
                            <option value="fruits">Fruits</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterCuisine">Cuisine</label>
                        <select id="filterCuisine" class="filter-control">
                            <option value="">All Cuisines</option>
                            <option value="american">American</option>
                            <option value="italian">Italian</option>
                            <option value="mexican">Mexican</option>
                            <option value="chinese">Chinese</option>
                            <option value="indian">Indian</option>
                            <option value="french">French</option>
                            <option value="thai">Thai</option>
                            <option value="japanese">Japanese</option>
                            <option value="mediterranean">Mediterranean</option>
                            <option value="middle-eastern">Middle Eastern</option>
                            <option value="korean">Korean</option>
                            <option value="greek">Greek</option>
                            <option value="spanish">Spanish</option>
                            <option value="german">German</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterDifficulty">Difficulty</label>
                        <select id="filterDifficulty" class="filter-control">
                            <option value="">All Levels</option>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterTime">Cooking Time</label>
                        <select id="filterTime" class="filter-control">
                            <option value="">All Times</option>
                            <option value="under-15">Under 15 minutes</option>
                            <option value="15-30">15-30 minutes</option>
                            <option value="30-60">30-60 minutes</option>
                            <option value="1-2-hours">1-2 hours</option>
                            <option value="over-2-hours">Over 2 hours</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterDietary">Dietary</label>
                        <select id="filterDietary" class="filter-control">
                            <option value="">All Dietary</option>
                            <option value="vegetarian">Vegetarian</option>
                            <option value="vegan">Vegan</option>
                            <option value="gluten-free">Gluten-Free</option>
                            <option value="dairy-free">Dairy-Free</option>
                            <option value="keto">Keto</option>
                            <option value="paleo">Paleo</option>
                        </select>
                    </div>
                </div>

                <div class="filter-actions">
                    <button id="applyFilters" class="btn-filter btn-apply">Apply Filters</button>
                    <button id="clearFilters" class="btn-filter btn-clear">Clear All</button>
                </div>
            </div>

            <!-- Sort Section -->
            <div class="sort-section">
                <span class="sort-label">Sort by:</span>
                <select id="sortSelect" class="sort-select">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="title-az">Title A-Z</option>
                    <option value="title-za">Title Z-A</option>
                    <option value="difficulty-easy">Difficulty: Easy to Hard</option>
                    <option value="difficulty-hard">Difficulty: Hard to Easy</option>
                    <option value="time-short">Time: Short to Long</option>
                    <option value="time-long">Time: Long to Short</option>
                </select>
            </div>
            
            <div id="recipesContainer">
                <div class="empty-state">
                    <h3>Your Recipe Collection Awaits</h3>
                    <p>Start by adding your first recipe using the "Add Recipe" tab above.</p>
                </div>
            </div>
        </section>

        <!-- Categories Management Section -->
        <section id="categories" class="section">
            <div class="import-section">
                <h2>Recipe Categories</h2>
                <p style="margin-bottom: 25px; color: var(--soft-brown); font-style: italic;">
                    View and manage your recipe categories. See how many recipes you have in each category.
                </p>
                
                <div id="categoriesContainer">
                    <div class="empty-state">
                        <h3>No Categories Yet</h3>
                        <p>Add some recipes with categories to see them organized here.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Social Media & Import Section -->
        <section id="social" class="section">
            <div class="container">
                <h2>üì± Social Media & Import</h2>
                
                <div class="social-grid">
                    <!-- Share Recipes -->
                    <div class="social-card">
                        <h3>üì§ Share Your Recipes</h3>
                        <p>Share your favorite recipes on social media or export your collection</p>
                        <div class="social-actions">
                            <button class="btn-primary" onclick="recipeKeeper.exportAllRecipes()">üì¶ Export All Recipes</button>
                            <button class="btn-secondary" onclick="recipeKeeper.generateQRCode()">üì± Generate QR Code</button>
                        </div>
                    </div>

                    <!-- Import Recipes -->
                    <div class="social-card">
                        <h3>üì• Import Recipes</h3>
                        <p>Import recipes from websites, social media, or files</p>
                        <div class="import-options">
                            <input type="url" id="websiteUrl" class="form-control" placeholder="Paste recipe website URL here...">
                            <button class="btn-primary" onclick="recipeKeeper.importFromWebsite()">üåê Import from Website</button>
                            
                            <div class="import-divider">
                                <span>or</span>
                            </div>
                            
                            <input type="url" id="socialMediaUrl" class="form-control" placeholder="Paste social media URL here...">
                            <button class="btn-secondary" onclick="recipeKeeper.importFromUrl()">üì± Import from Social Media</button>
                            
                            <div class="file-import">
                                <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                                <button class="btn-secondary" onclick="document.getElementById('jsonFileInput').click()">üìÑ Import JSON File</button>
                            </div>
                        </div>
                    </div>

                    <!-- OCR Scanning -->
                    <div class="social-card">
                        <h3>üì∑ Scan Recipes</h3>
                        <p>Scan cookbooks, magazines, and handwritten recipes</p>
                        <div class="ocr-options">
                            <input type="file" id="ocrFileInput" accept="image/*,.pdf" style="display: none;" multiple>
                            <button class="btn-primary" onclick="document.getElementById('ocrFileInput').click()">üì∑ Scan Images/PDF</button>
                            
                            <div class="camera-option">
                                <button class="btn-secondary" onclick="recipeKeeper.startCameraScan()">üì± Use Camera</button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Share -->
                    <div class="social-card">
                        <h3>‚ö° Quick Share</h3>
                        <p>Share individual recipes instantly</p>
                        <div class="quick-share-buttons">
                            <button class="btn-social facebook" onclick="recipeKeeper.shareToFacebook()">üìò Facebook</button>
                            <button class="btn-social twitter" onclick="recipeKeeper.shareToTwitter()">üê¶ Twitter</button>
                            <button class="btn-social whatsapp" onclick="recipeKeeper.shareToWhatsApp()">üí¨ WhatsApp</button>
                            <button class="btn-social email" onclick="recipeKeeper.shareViaEmail()">üìß Email</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Shopping List Section -->
        <section id="shopping" class="section">
            <div class="container">
                <h2>üõí Shopping List</h2>
                <p style="margin-bottom: 25px; color: var(--soft-brown); font-style: italic;">
                    Generate shopping lists from your recipes and organize by grocery store aisles.
                </p>
                
                <div class="shopping-controls">
                    <div class="shopping-actions">
                        <button class="btn-primary" onclick="recipeKeeper.generateShoppingList()">üõí Generate from Recipes</button>
                        <button class="btn-secondary" onclick="recipeKeeper.addCustomItem()">‚ûï Add Custom Item</button>
                        <button class="btn-secondary" onclick="recipeKeeper.clearShoppingList()">üóëÔ∏è Clear All</button>
                        <button class="btn-secondary" onclick="recipeKeeper.exportShoppingList()">üì§ Export List</button>
                    </div>
                    
                    <div class="shopping-options">
                        <label>
                            <input type="checkbox" id="groupByAisle" checked> Group by Aisle
                        </label>
                        <label>
                            <input type="checkbox" id="showQuantities" checked> Show Quantities
                        </label>
                        <label>
                            <input type="checkbox" id="markCompleted"> Hide Completed
                        </label>
                    </div>
                </div>

                <div class="shopping-list" id="shoppingListContainer">
                    <div class="empty-state">
                        <h3>üõí No Shopping List Yet</h3>
                        <p>Generate a shopping list from your recipes or add items manually.</p>
                    </div>
                </div>

                <!-- Custom Item Modal -->
                <div id="customItemModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>‚ûï Add Custom Item</h3>
                            <button class="close-btn" onclick="recipeKeeper.closeCustomItemModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="customItemName">Item Name</label>
                                <input type="text" id="customItemName" class="form-control" placeholder="e.g., Milk, Bread, Apples">
                            </div>
                            <div class="form-group">
                                <label for="customItemQuantity">Quantity</label>
                                <input type="text" id="customItemQuantity" class="form-control" placeholder="e.g., 2 cups, 1 lb, 6 pieces">
                            </div>
                            <div class="form-group">
                                <label for="customItemAisle">Aisle Category</label>
                                <select id="customItemAisle" class="form-control">
                                    <option value="produce">ü•¨ Produce</option>
                                    <option value="dairy">ü•õ Dairy & Eggs</option>
                                    <option value="meat">ü•© Meat & Seafood</option>
                                    <option value="bakery">üçû Bakery</option>
                                    <option value="frozen">‚ùÑÔ∏è Frozen Foods</option>
                                    <option value="pantry">ü•´ Pantry & Canned</option>
                                    <option value="beverages">ü•§ Beverages</option>
                                    <option value="snacks">üçø Snacks & Candy</option>
                                    <option value="health">üíä Health & Beauty</option>
                                    <option value="household">üßΩ Household</option>
                                    <option value="other">üì¶ Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="recipeKeeper.closeCustomItemModal()">Cancel</button>
                            <button class="btn-primary" onclick="recipeKeeper.saveCustomItem()">Add Item</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Unit Conversion Modal -->
        <div id="unitConversionModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>üîÑ Unit Conversion</h3>
                    <button class="close-btn" onclick="recipeKeeper.closeUnitConversionModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Convert measurements between US/Imperial and Metric units in your recipe.</p>
                    
                    <div class="conversion-options">
                        <div class="conversion-option">
                            <label>
                                <input type="radio" name="conversionType" value="us-to-metric" checked>
                                US/Imperial ‚Üí Metric
                            </label>
                        </div>
                        <div class="conversion-option">
                            <label>
                                <input type="radio" name="conversionType" value="metric-to-us">
                                Metric ‚Üí US/Imperial
                            </label>
                        </div>
                    </div>

                    <div class="conversion-preview">
                        <h4>Preview Conversions:</h4>
                        <div id="conversionPreview" class="conversion-list"></div>
                    </div>

                    <div class="conversion-actions">
                        <button class="btn-secondary" onclick="recipeKeeper.closeUnitConversionModal()">Cancel</button>
                        <button class="btn-primary" onclick="recipeKeeper.applyUnitConversion()">Apply Conversion</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- OCR Scanning Modal -->
        <div id="ocrScanModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3>üì∑ OCR Recipe Scanner</h3>
                    <button class="close-btn" onclick="recipeKeeper.closeOCRModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="ocr-interface">
                        <div class="camera-container" id="cameraContainer" style="display: none;">
                            <video id="cameraVideo" autoplay muted style="width: 100%; max-width: 400px; border-radius: 10px;"></video>
                            <canvas id="cameraCanvas" style="display: none;"></canvas>
                            <div class="camera-controls">
                                <button class="btn-primary" onclick="recipeKeeper.capturePhoto()">üì∑ Capture</button>
                                <button class="btn-secondary" onclick="recipeKeeper.stopCamera()">‚ùå Stop Camera</button>
                            </div>
                        </div>
                        
                        <div class="image-preview" id="imagePreview" style="display: none;">
                            <img id="previewImage" style="max-width: 100%; max-height: 400px; border-radius: 10px;">
                            <div class="image-controls">
                                <button class="btn-primary" onclick="recipeKeeper.processImage()">üîç Extract Text</button>
                                <button class="btn-secondary" onclick="recipeKeeper.retakePhoto()">üîÑ Retake</button>
                            </div>
                        </div>
                        
                        <div class="ocr-results" id="ocrResults" style="display: none;">
                            <h4>Extracted Text:</h4>
                            <textarea id="extractedText" class="form-control" rows="10" placeholder="Extracted text will appear here..."></textarea>
                            <div class="ocr-actions">
                                <button class="btn-secondary" onclick="recipeKeeper.editExtractedText()">‚úèÔ∏è Edit Text</button>
                                <button class="btn-primary" onclick="recipeKeeper.createRecipeFromOCR()">üìù Create Recipe</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Website Import Modal -->
        <div id="websiteImportModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3>üåê Website Recipe Import</h3>
                    <button class="close-btn" onclick="recipeKeeper.closeWebsiteImportModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="import-status" id="importStatus">
                        <div class="loading-spinner"></div>
                        <p>Analyzing website and extracting recipe data...</p>
                    </div>
                    
                    <div class="import-results" id="importResults" style="display: none;">
                        <h4>Found Recipe:</h4>
                        <div class="imported-recipe-preview">
                            <h5 id="importedTitle"></h5>
                            <div id="importedContent" class="recipe-content"></div>
                        </div>
                        <div class="import-actions">
                            <button class="btn-secondary" onclick="recipeKeeper.editImportedRecipe()">‚úèÔ∏è Edit Before Import</button>
                            <button class="btn-primary" onclick="recipeKeeper.confirmImport()">‚úÖ Import Recipe</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recipe Detail Modal -->
    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Recipe Title</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="recipe-detail" id="modalContent">
                <!-- Recipe content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        class RecipeKeeper {
            constructor() {
                this.recipes = this.loadRecipes();
                this.shoppingList = this.loadShoppingList();
                this.currentEditId = null;
                this.initializeEventListeners();
                this.initializeRatingSystem();
                this.initializePhotoPreview();
                this.initializeFileImport();
                this.initializeShoppingList();
                this.initializeRichTextEditor();
                this.initializeOCRFileHandling();
                this.renderRecipes();
                this.handleSharedRecipe();
            }

            initializeEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchSection(e.target.dataset.section));
                });

                // Form submission
                document.getElementById('recipeForm').addEventListener('submit', (e) => this.handleFormSubmit(e));

                // Search
                document.getElementById('searchInput').addEventListener('input', (e) => this.handleSearch(e.target.value));

                // Filter controls
                document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
                document.getElementById('clearFilters').addEventListener('click', () => this.clearFilters());
                document.getElementById('sortSelect').addEventListener('change', (e) => this.handleSort(e.target.value));

                // Auto-detect categories
                document.getElementById('autoDetectBtn').addEventListener('click', () => this.autoDetectCategories());

                // Modal
                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());
                document.getElementById('recipeModal').addEventListener('click', (e) => {
                    if (e.target.id === 'recipeModal') this.closeModal();
                });

                // Escape key to close modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeModal();
                });
            }

            switchSection(sectionName) {
                // Update nav buttons
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

                // Update sections
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                document.getElementById(sectionName).classList.add('active');

                if (sectionName === 'recipes') {
                    this.renderRecipes();
                } else if (sectionName === 'categories') {
                    this.renderCategories();
                }
            }

            async handleFormSubmit(e) {
                e.preventDefault();
                const title = document.getElementById('recipeTitle').value.trim();
                const content = this.getRichTextContent();

                if (!title || !content) return;

                // Show loading for longer recipes
                if (content.length > 1000) {
                    this.showLoading('Organizing your recipe...');
                }

                try {
                    // Use setTimeout to allow UI to update
                    const processedRecipe = await new Promise(async resolve => {
                        setTimeout(async () => {
                            const recipe = this.processRecipeContent(title, content);
                            // Handle photo data asynchronously
                            if (recipe.photo) {
                                recipe.photo = await this.getPhotoDataSync();
                            }
                            resolve(recipe);
                        }, 10);
                    });
                    
                    if (this.currentEditId) {
                        this.updateRecipe(this.currentEditId, processedRecipe);
                        this.currentEditId = null;
                    } else {
                        this.addRecipe(processedRecipe);
                    }

                    this.resetForm();
                    this.switchSection('recipes');
                } catch (error) {
                    console.error('Error processing recipe:', error);
                    alert('There was an error processing your recipe. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }

            processRecipeContent(title, content) {
                const recipe = {
                    id: this.currentEditId || Date.now().toString(),
                    title: title.trim(),
                    content: content.trim(),
                    createdAt: new Date().toISOString(),
                    ingredients: [],
                    instructions: [],
                    servings: '',
                    prepTime: '',
                    cookTime: '',
                    // New category fields
                    type: document.getElementById('recipeType').value,
                    mainIngredient: document.getElementById('mainIngredient').value,
                    cuisine: document.getElementById('cuisine').value,
                    difficulty: document.getElementById('difficulty').value,
                    cookTimeCategory: document.getElementById('cookTime').value,
                    dietary: this.getSelectedDietaryRestrictions(),
                    // New features
                    rating: 0,
                    isFavorite: false,
                    photo: null,
                    nutrition: {
                        calories: '',
                        protein: '',
                        carbs: '',
                        fat: '',
                        fiber: '',
                        sugar: '',
                        sodium: ''
                    },
                    videoUrl: '',
                    relatedRecipes: [],
                    notes: ''
                };

                // Auto-detect categories if not already set
                if (!recipe.type) {
                    recipe.type = this.detectRecipeType(title, content);
                }
                if (!recipe.mainIngredient) {
                    recipe.mainIngredient = this.detectMainIngredient(content);
                }
                if (!recipe.cuisine) {
                    recipe.cuisine = this.detectCuisine(title, content);
                }
                if (!recipe.difficulty) {
                    recipe.difficulty = this.detectDifficulty(content);
                }
                if (!recipe.cookTimeCategory) {
                    recipe.cookTimeCategory = this.detectCookingTime(content);
                }
                if (!recipe.dietary || recipe.dietary.length === 0) {
                    recipe.dietary = this.detectDietaryRestrictions(content);
                }

                // Get additional features from form
                recipe.rating = this.getCurrentRating();
                recipe.isFavorite = document.getElementById('isFavorite').checked;
                recipe.photo = this.getPhotoData();
                recipe.videoUrl = document.getElementById('videoUrl').value.trim();
                recipe.notes = document.getElementById('recipeNotes').value.trim();
                
                // Get nutrition information
                recipe.nutrition = {
                    calories: document.getElementById('calories').value || '',
                    protein: document.getElementById('protein').value || '',
                    carbs: document.getElementById('carbs').value || '',
                    fat: document.getElementById('fat').value || '',
                    fiber: document.getElementById('fiber').value || '',
                    sugar: document.getElementById('sugar').value || '',
                    sodium: document.getElementById('sodium').value || ''
                };

                // Quick extraction - only process if content is reasonable length
                if (content.length > 50000) {
                    // For very long content, skip processing to avoid slowdown
                    return recipe;
                }

                // Pre-compile regex patterns for better performance
                const sectionPatterns = {
                    ingredients: /(ingredient|what you need)/i,
                    instructions: /(instruction|method|directions|steps|how to make)/i,
                    servings: /(serves?|serving)/i,
                    prepTime: /prep.*time/i,
                    cookTime: /cook.*time/i
                };

                const lines = content.split('\n');
                let currentSection = 'general';
                const ingredients = [];
                const instructions = [];
                
                // Process lines more efficiently
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const lowerLine = line.toLowerCase();
                    
                    // Check for section headers
                    if (sectionPatterns.ingredients.test(lowerLine)) {
                        currentSection = 'ingredients';
                        continue;
                    }
                    if (sectionPatterns.instructions.test(lowerLine)) {
                        currentSection = 'instructions';
                        continue;
                    }
                    
                    // Extract meta information (only check first 20 lines for performance)
                    if (i < 20) {
                        if (sectionPatterns.servings.test(lowerLine)) {
                            recipe.servings = line;
                            continue;
                        }
                        if (sectionPatterns.prepTime.test(lowerLine)) {
                            recipe.prepTime = line;
                            continue;
                        }
                        if (sectionPatterns.cookTime.test(lowerLine)) {
                            recipe.cookTime = line;
                            continue;
                        }
                    }
                    
                    // Categorize content based on current section
                    if (currentSection === 'ingredients' && !sectionPatterns.ingredients.test(lowerLine)) {
                        ingredients.push(line);
                    } else if (currentSection === 'instructions' && 
                               !sectionPatterns.instructions.test(lowerLine) &&
                               !sectionPatterns.ingredients.test(lowerLine)) {
                        instructions.push(line);
                    }
                }
                
                recipe.ingredients = ingredients;
                recipe.instructions = instructions;
                
                return recipe;
            }

            addRecipe(recipe) {
                this.recipes.push(recipe);
                this.saveRecipes();
                this.renderRecipes();
            }

            updateRecipe(id, updatedRecipe) {
                const index = this.recipes.findIndex(r => r.id === id);
                if (index !== -1) {
                    this.recipes[index] = { ...updatedRecipe, id };
                    this.saveRecipes();
                    this.renderRecipes();
                }
            }

            deleteRecipe(id) {
                const recipe = this.recipes.find(r => r.id === id);
                if (!recipe) return;

                this.showDeleteConfirmation(recipe.title, () => {
                    this.recipes = this.recipes.filter(r => r.id !== id);
                    this.saveRecipes();
                    this.renderRecipes();
                });
            }

            showDeleteConfirmation(recipeName, onConfirm) {
                const modal = document.createElement('div');
                modal.id = 'delete-confirmation-modal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--warm-white); padding: 30px; border-radius: 15px; box-shadow: 0 8px 32px var(--shadow); max-width: 400px; width: 90%; text-align: center;">
                            <h3 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; margin-bottom: 15px;">Delete Recipe?</h3>
                            <p style="color: var(--soft-brown); margin-bottom: 25px; font-size: 1.1rem;">Are you sure you want to delete "${this.escapeHtml(recipeName)}"? This action cannot be undone.</p>
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button id="cancel-delete" style="background: var(--light-sage); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1rem; cursor: pointer;">Cancel</button>
                                <button id="confirm-delete" style="background: var(--terracotta); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1rem; cursor: pointer;">Delete</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const cancelBtn = modal.querySelector('#cancel-delete');
                const confirmBtn = modal.querySelector('#confirm-delete');

                const cleanup = () => {
                    modal.remove();
                };

                cancelBtn.addEventListener('click', cleanup);
                confirmBtn.addEventListener('click', () => {
                    onConfirm();
                    cleanup();
                });

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) cleanup();
                });

                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            }

            editRecipe(id) {
                const recipe = this.recipes.find(r => r.id === id);
                if (recipe) {
                    document.getElementById('recipeTitle').value = recipe.title;
                    this.setRichTextContent(recipe.content);
                    
                    // Populate category fields
                    if (recipe.type) document.getElementById('recipeType').value = recipe.type;
                    if (recipe.mainIngredient) document.getElementById('mainIngredient').value = recipe.mainIngredient;
                    if (recipe.cuisine) document.getElementById('cuisine').value = recipe.cuisine;
                    if (recipe.difficulty) document.getElementById('difficulty').value = recipe.difficulty;
                    if (recipe.cookTimeCategory) document.getElementById('cookTime').value = recipe.cookTimeCategory;
                    
                    // Clear and set dietary restrictions
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    if (recipe.dietary) {
                        recipe.dietary.forEach(diet => {
                            const checkbox = document.querySelector(`input[value="${diet}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    
                    // Populate additional features
                    if (recipe.rating) this.setRating(recipe.rating);
                    if (recipe.isFavorite) document.getElementById('isFavorite').checked = true;
                    if (recipe.videoUrl) document.getElementById('videoUrl').value = recipe.videoUrl;
                    if (recipe.notes) document.getElementById('recipeNotes').value = recipe.notes;
                    
                    // Populate nutrition information
                    if (recipe.nutrition) {
                        Object.keys(recipe.nutrition).forEach(key => {
                            const field = document.getElementById(key);
                            if (field && recipe.nutrition[key]) {
                                field.value = recipe.nutrition[key];
                            }
                        });
                    }
                    
                    // Handle photo (if exists)
                    if (recipe.photo) {
                        const photoPreview = document.getElementById('photoPreview');
                        photoPreview.innerHTML = `<img src="${recipe.photo}" class="photo-preview" alt="Recipe preview">`;
                    }
                    
                    this.currentEditId = id;
                    this.switchSection('import');
                }
            }

            buildCategoryTags(recipe) {
                let tags = '';
                
                if (recipe.type) {
                    tags += `<span class="category-tag type">${this.formatCategoryValue(recipe.type)}</span>`;
                }
                if (recipe.mainIngredient) {
                    tags += `<span class="category-tag ingredient">${this.formatCategoryValue(recipe.mainIngredient)}</span>`;
                }
                if (recipe.cuisine) {
                    tags += `<span class="category-tag cuisine">${this.formatCategoryValue(recipe.cuisine)}</span>`;
                }
                if (recipe.difficulty) {
                    tags += `<span class="category-tag difficulty">${this.formatCategoryValue(recipe.difficulty)}</span>`;
                }
                if (recipe.cookTimeCategory) {
                    tags += `<span class="category-tag time">${this.formatCategoryValue(recipe.cookTimeCategory)}</span>`;
                }
                if (recipe.dietary && recipe.dietary.length > 0) {
                    recipe.dietary.forEach(diet => {
                        tags += `<span class="category-tag dietary">${this.formatCategoryValue(diet)}</span>`;
                    });
                }
                
                return tags;
            }

            formatCategoryValue(value) {
                return value.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            // Intelligent Category Detection Methods
            detectRecipeType(title, content) {
                const text = (title + ' ' + content).toLowerCase();
                
                // Breakfast patterns
                if (/\b(breakfast|pancake|waffle|omelet|omelette|french toast|granola|cereal|muffin|bagel|toast|eggs|bacon|sausage|hash|frittata)\b/.test(text)) {
                    return 'breakfast';
                }
                
                // Appetizer patterns
                if (/\b(appetizer|starter|hors d'oeuvre|dip|spread|bruschetta|crostini|canap√©|finger food|snack|nibble)\b/.test(text)) {
                    return 'appetizer';
                }
                
                // Soup patterns
                if (/\b(soup|broth|bisque|chowder|gazpacho|consomm√©|stew|gumbo|chili)\b/.test(text)) {
                    return 'soup';
                }
                
                // Salad patterns
                if (/\b(salad|lettuce|greens|caesar|cobb|ni√ßoise|caprese|coleslaw|slaw)\b/.test(text)) {
                    return 'salad';
                }
                
                // Dessert patterns
                if (/\b(dessert|cake|pie|tart|cookie|brownie|ice cream|pudding|mousse|cheesecake|truffle|candy|sweet|chocolate|sugar)\b/.test(text)) {
                    return 'dessert';
                }
                
                // Beverage patterns
                if (/\b(drink|beverage|smoothie|juice|tea|coffee|cocktail|mocktail|punch|lemonade|soda)\b/.test(text)) {
                    return 'beverage';
                }
                
                // Bread patterns
                if (/\b(bread|loaf|roll|bun|bagel|pretzel|flatbread|naan|pita|focaccia|sourdough)\b/.test(text)) {
                    return 'bread';
                }
                
                // Sauce patterns
                if (/\b(sauce|dressing|marinade|glaze|syrup|reduction|gravy|pesto|aioli|mayo|ketchup|mustard)\b/.test(text)) {
                    return 'sauce';
                }
                
                // Main course (default for substantial recipes)
                if (/\b(beef|chicken|pork|fish|seafood|pasta|rice|quinoa|beans|lentils|tofu|tempeh|main|dinner|lunch)\b/.test(text)) {
                    return 'main-course';
                }
                
                // Side dish patterns
                if (/\b(side|accompaniment|vegetable|potato|fries|mashed|roasted|steamed|grilled|saut√©ed)\b/.test(text)) {
                    return 'side-dish';
                }
                
                return 'main-course'; // Default fallback
            }

            detectMainIngredient(content) {
                const text = content.toLowerCase();
                
                // Protein detection
                if (/\b(chicken|poultry|hen|breast|thigh|wing|drumstick)\b/.test(text)) return 'chicken';
                if (/\b(beef|steak|ground beef|hamburger|roast|brisket|ribs)\b/.test(text)) return 'beef';
                if (/\b(pork|ham|bacon|sausage|chop|tenderloin|ribs)\b/.test(text)) return 'pork';
                if (/\b(fish|salmon|tuna|cod|halibut|trout|bass|mackerel|sardine)\b/.test(text)) return 'fish';
                if (/\b(seafood|shrimp|prawn|crab|lobster|scallop|mussel|oyster|clam|squid|octopus)\b/.test(text)) return 'seafood';
                
                // Starch detection
                if (/\b(pasta|noodle|spaghetti|penne|fettuccine|macaroni|lasagna|ravioli)\b/.test(text)) return 'pasta';
                if (/\b(rice|basmati|jasmine|brown rice|wild rice|risotto|arroz)\b/.test(text)) return 'rice';
                if (/\b(potato|potatoes|sweet potato|yam|mashed|fries|hash)\b/.test(text)) return 'potatoes';
                
                // Other proteins
                if (/\b(egg|eggs|omelet|omelette|frittata|quiche)\b/.test(text)) return 'eggs';
                if (/\b(cheese|cheddar|mozzarella|parmesan|feta|goat cheese|ricotta)\b/.test(text)) return 'cheese';
                if (/\b(bean|beans|lentil|lentils|chickpea|black bean|kidney bean|pinto bean)\b/.test(text)) return 'beans';
                if (/\b(nut|nuts|almond|walnut|pecan|cashew|pistachio|peanut)\b/.test(text)) return 'nuts';
                
                // Fruits and vegetables
                if (/\b(fruit|apple|banana|berry|strawberry|blueberry|orange|lemon|lime|grape|peach|pear)\b/.test(text)) return 'fruits';
                if (/\b(vegetable|vegetables|carrot|onion|garlic|tomato|pepper|broccoli|spinach|lettuce|celery|cucumber)\b/.test(text)) return 'vegetables';
                
                return 'other';
            }

            detectCuisine(title, content) {
                const text = (title + ' ' + content).toLowerCase();
                
                // Italian patterns
                if (/\b(italian|pasta|pizza|risotto|bruschetta|parmesan|mozzarella|basil|oregano|marinara|alfredo|carbonara|pesto|gnocchi|ravioli|lasagna)\b/.test(text)) {
                    return 'italian';
                }
                
                // Mexican patterns
                if (/\b(mexican|taco|burrito|enchilada|quesadilla|salsa|guacamole|jalape√±o|cilantro|cumin|chili|tortilla|fajita|nacho)\b/.test(text)) {
                    return 'mexican';
                }
                
                // Chinese patterns
                if (/\b(chinese|soy sauce|ginger|sesame|wok|stir fry|lo mein|fried rice|dumpling|wonton|bok choy|hoisin|oyster sauce)\b/.test(text)) {
                    return 'chinese';
                }
                
                // Indian patterns
                if (/\b(indian|curry|masala|garam|tandoor|naan|basmati|cardamom|cumin|coriander|turmeric|ginger|garlic|chili|dal|lentil)\b/.test(text)) {
                    return 'indian';
                }
                
                // French patterns
                if (/\b(french|herbes de provence|thyme|rosemary|tarragon|dijon|b√©chamel|hollandaise|ratatouille|coq au vin|bouillabaisse)\b/.test(text)) {
                    return 'french';
                }
                
                // Thai patterns
                if (/\b(thai|lemongrass|galangal|fish sauce|coconut milk|curry paste|pad thai|tom yum|basil|mint|cilantro|kaffir lime)\b/.test(text)) {
                    return 'thai';
                }
                
                // Japanese patterns
                if (/\b(japanese|sushi|sashimi|miso|soy sauce|wasabi|ginger|teriyaki|tempura|ramen|udon|mirin|sake)\b/.test(text)) {
                    return 'japanese';
                }
                
                // Mediterranean patterns
                if (/\b(mediterranean|olive oil|feta|olives|sun dried tomato|artichoke|hummus|tzatziki|oregano|basil|lemon|garlic)\b/.test(text)) {
                    return 'mediterranean';
                }
                
                // Middle Eastern patterns
                if (/\b(middle eastern|hummus|tahini|pita|falafel|sumac|za'atar|cardamom|cinnamon|pistachio|pomegranate|yogurt)\b/.test(text)) {
                    return 'middle-eastern';
                }
                
                // Korean patterns
                if (/\b(korean|kimchi|gochujang|sesame oil|soy sauce|garlic|ginger|scallion|bulgogi|bibimbap|korean bbq)\b/.test(text)) {
                    return 'korean';
                }
                
                // Greek patterns
                if (/\b(greek|feta|olive|oregano|lemon|garlic|tzatziki|hummus|pita|spanakopita|moussaka|baklava)\b/.test(text)) {
                    return 'greek';
                }
                
                // Spanish patterns
                if (/\b(spanish|paella|saffron|chorizo|jam√≥n|sherry|olive oil|garlic|paprika|sangria|tapas|gazpacho)\b/.test(text)) {
                    return 'spanish';
                }
                
                // German patterns
                if (/\b(german|sauerkraut|bratwurst|beer|mustard|caraway|dill|potato|cabbage|pretzel|schnitzel)\b/.test(text)) {
                    return 'german';
                }
                
                return 'american'; // Default fallback
            }

            detectDifficulty(content) {
                const text = content.toLowerCase();
                
                // Easy patterns
                if (/\b(simple|easy|quick|basic|minimal|few ingredients|no cook|raw|mix|stir|combine|toss|blend)\b/.test(text)) {
                    return 'easy';
                }
                
                // Hard patterns
                if (/\b(complex|advanced|difficult|challenging|multi step|layered|temper|sous vide|ferment|proof|knead|fold|whip|emulsify|caramelize|braise|confit)\b/.test(text)) {
                    return 'hard';
                }
                
                // Medium patterns
                if (/\b(medium|moderate|intermediate|saute|roast|bake|grill|fry|simmer|reduce|marinate|brine|rest|chill)\b/.test(text)) {
                    return 'medium';
                }
                
                // Time-based difficulty
                const timeWords = text.match(/\b(\d+)\s*(minute|hour|day)s?\b/g);
                if (timeWords) {
                    const totalMinutes = timeWords.reduce((total, time) => {
                        const match = time.match(/(\d+)\s*(minute|hour|day)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            const unit = match[2];
                            if (unit === 'hour') return total + (num * 60);
                            if (unit === 'day') return total + (num * 1440);
                            return total + num;
                        }
                        return total;
                    }, 0);
                    
                    if (totalMinutes <= 30) return 'easy';
                    if (totalMinutes <= 120) return 'medium';
                    return 'hard';
                }
                
                return 'medium'; // Default fallback
            }

            detectCookingTime(content) {
                const text = content.toLowerCase();
                
                // Extract time information
                const timeMatches = text.match(/\b(\d+)\s*(minute|hour|day)s?\b/g);
                if (!timeMatches) return '30-60'; // Default fallback
                
                let totalMinutes = 0;
                timeMatches.forEach(time => {
                    const match = time.match(/(\d+)\s*(minute|hour|day)/);
                    if (match) {
                        const num = parseInt(match[1]);
                        const unit = match[2];
                        if (unit === 'hour') totalMinutes += (num * 60);
                        else if (unit === 'day') totalMinutes += (num * 1440);
                        else totalMinutes += num;
                    }
                });
                
                if (totalMinutes <= 15) return 'under-15';
                if (totalMinutes <= 30) return '15-30';
                if (totalMinutes <= 60) return '30-60';
                if (totalMinutes <= 120) return '1-2-hours';
                return 'over-2-hours';
            }

            detectDietaryRestrictions(content) {
                const text = content.toLowerCase();
                const dietary = [];
                
                // Vegetarian detection
                if (/\b(vegetarian|veggie|no meat|plant based|vegetable|veggie)\b/.test(text) && 
                    !/\b(meat|chicken|beef|pork|fish|seafood|bacon|ham|sausage)\b/.test(text)) {
                    dietary.push('vegetarian');
                }
                
                // Vegan detection
                if (/\b(vegan|no dairy|no eggs|plant based|dairy free|egg free)\b/.test(text) && 
                    !/\b(meat|chicken|beef|pork|fish|seafood|dairy|milk|cheese|butter|cream|egg)\b/.test(text)) {
                    dietary.push('vegan');
                }
                
                // Gluten-free detection
                if (/\b(gluten free|gluten-free|no gluten|gf)\b/.test(text) && 
                    !/\b(wheat|flour|bread|pasta|barley|rye|oats)\b/.test(text)) {
                    dietary.push('gluten-free');
                }
                
                // Dairy-free detection
                if (/\b(dairy free|dairy-free|no dairy|lactose free|lactose-free)\b/.test(text) && 
                    !/\b(milk|cheese|butter|cream|yogurt|dairy)\b/.test(text)) {
                    dietary.push('dairy-free');
                }
                
                // Keto detection
                if (/\b(keto|ketogenic|low carb|low carb|no sugar|sugar free)\b/.test(text) && 
                    !/\b(bread|pasta|rice|potato|sugar|honey|maple syrup)\b/.test(text)) {
                    dietary.push('keto');
                }
                
                // Paleo detection
                if (/\b(paleo|paleolithic|primal|no grains|no dairy|no legumes)\b/.test(text) && 
                    !/\b(grains|dairy|legumes|beans|lentils|soy)\b/.test(text)) {
                    dietary.push('paleo');
                }
                
                return dietary;
            }

            autoDetectCategories() {
                const title = document.getElementById('recipeTitle').value.trim();
                const content = document.getElementById('recipeText').value.trim();
                
                if (!title && !content) {
                    this.showMessage('Please enter a recipe title and content first!', 'error');
                    return;
                }
                
                // Show loading
                this.showLoading('Analyzing recipe content...');
                
                // Simulate processing time for better UX
                setTimeout(() => {
                    // Auto-detect categories
                    const detectedType = this.detectRecipeType(title, content);
                    const detectedIngredient = this.detectMainIngredient(content);
                    const detectedCuisine = this.detectCuisine(title, content);
                    const detectedDifficulty = this.detectDifficulty(content);
                    const detectedTime = this.detectCookingTime(content);
                    const detectedDietary = this.detectDietaryRestrictions(content);
                    
                    // Update form fields
                    if (detectedType) {
                        document.getElementById('recipeType').value = detectedType;
                        this.highlightField('recipeType');
                    }
                    if (detectedIngredient) {
                        document.getElementById('mainIngredient').value = detectedIngredient;
                        this.highlightField('mainIngredient');
                    }
                    if (detectedCuisine) {
                        document.getElementById('cuisine').value = detectedCuisine;
                        this.highlightField('cuisine');
                    }
                    if (detectedDifficulty) {
                        document.getElementById('difficulty').value = detectedDifficulty;
                        this.highlightField('difficulty');
                    }
                    if (detectedTime) {
                        document.getElementById('cookTime').value = detectedTime;
                        this.highlightField('cookTime');
                    }
                    
                    // Update dietary checkboxes
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    detectedDietary.forEach(diet => {
                        const checkbox = document.querySelector(`input[value="${diet}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            this.highlightField(checkbox);
                        }
                    });
                    
                    this.hideLoading();
                    
                    const detectedCount = [detectedType, detectedIngredient, detectedCuisine, detectedDifficulty, detectedTime].filter(Boolean).length + detectedDietary.length;
                    this.showMessage(`ü§ñ Auto-detected ${detectedCount} categories!`, 'success');
                    
                }, 1000);
            }

            highlightField(fieldId) {
                const field = typeof fieldId === 'string' ? document.getElementById(fieldId) : fieldId;
                if (field) {
                    field.style.borderColor = 'var(--sage)';
                    field.style.boxShadow = '0 0 0 3px rgba(156, 175, 136, 0.3)';
                    
                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        field.style.borderColor = '';
                        field.style.boxShadow = '';
                    }, 3000);
                }
            }

            // New Feature Helper Methods
            getCurrentRating() {
                const activeStars = document.querySelectorAll('.star.active');
                return activeStars.length;
            }

            getPhotoData() {
                const photoInput = document.getElementById('recipePhoto');
                if (photoInput.files && photoInput.files[0]) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(photoInput.files[0]);
                    });
                }
                return null;
            }

            async getPhotoDataSync() {
                const photoInput = document.getElementById('recipePhoto');
                if (photoInput.files && photoInput.files[0]) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(photoInput.files[0]);
                    });
                }
                return null;
            }

            initializeRatingSystem() {
                const stars = document.querySelectorAll('.star');
                const ratingText = document.getElementById('ratingText');
                
                stars.forEach((star, index) => {
                    star.addEventListener('click', () => {
                        const rating = index + 1;
                        this.setRating(rating);
                    });
                    
                    star.addEventListener('mouseenter', () => {
                        this.highlightStars(index + 1);
                    });
                });
                
                document.getElementById('starRating').addEventListener('mouseleave', () => {
                    this.highlightStars(this.getCurrentRating());
                });
            }

            setRating(rating) {
                const stars = document.querySelectorAll('.star');
                const ratingText = document.getElementById('ratingText');
                
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
                
                const ratingLabels = ['No rating', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                ratingText.textContent = ratingLabels[rating];
            }

            highlightStars(rating) {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.style.color = '#ffd700';
                    } else {
                        star.style.color = '#ddd';
                    }
                });
            }

            initializePhotoPreview() {
                const photoInput = document.getElementById('recipePhoto');
                const photoPreview = document.getElementById('photoPreview');
                
                photoInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            photoPreview.innerHTML = `<img src="${e.target.result}" class="photo-preview" alt="Recipe preview">`;
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    } else {
                        photoPreview.innerHTML = '';
                    }
                });
            }

            // Cooking Mode Methods
            startCookingMode(recipeId) {
                const recipe = this.recipes.find(r => r.id === recipeId);
                if (!recipe) return;

                // Disable screen lock (if supported)
                if ('wakeLock' in navigator) {
                    navigator.wakeLock.request('screen').catch(err => {
                        console.log('Screen lock disable not supported:', err);
                    });
                }

                // Create cooking mode overlay
                const cookingMode = document.createElement('div');
                cookingMode.className = 'cooking-mode';
                cookingMode.id = 'cookingMode';
                
                // Parse ingredients and instructions
                const ingredients = recipe.ingredients.length > 0 ? recipe.ingredients : 
                    this.extractIngredientsFromContent(recipe.content);
                const instructions = recipe.instructions.length > 0 ? recipe.instructions : 
                    this.extractInstructionsFromContent(recipe.content);

                cookingMode.innerHTML = `
                    <div class="cooking-header">
                        <h2>üë®‚Äçüç≥ Cooking: ${this.escapeHtml(recipe.title)}</h2>
                        <div class="text-size-controls">
                            <button class="text-size-btn" onclick="recipeKeeper.adjustTextSize(-1)">A-</button>
                            <span>Text Size</span>
                            <button class="text-size-btn" onclick="recipeKeeper.adjustTextSize(1)">A+</button>
                        </div>
                    </div>
                    
                    <div class="cooking-content">
                        <div class="ingredients-section">
                            <h3>üìù Ingredients</h3>
                            <div id="ingredientsList">
                                ${ingredients.map((ingredient, index) => `
                                    <div class="ingredient-item">
                                        <input type="checkbox" class="ingredient-checkbox" id="ingredient-${index}">
                                        <label for="ingredient-${index}">${this.escapeHtml(ingredient)}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="instructions-section">
                            <h3>üë®‚Äçüç≥ Instructions</h3>
                            <div id="instructionsList">
                                ${instructions.map((instruction, index) => `
                                    <div class="step-item" id="step-${index}">
                                        <strong>Step ${index + 1}:</strong> ${this.escapeHtml(instruction)}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="cooking-controls">
                        <button class="btn-cooking" onclick="recipeKeeper.previousStep()">‚¨ÖÔ∏è Previous</button>
                        <button class="btn-cooking" onclick="recipeKeeper.nextStep()">Next ‚û°Ô∏è</button>
                        <button class="btn-cooking" onclick="recipeKeeper.exitCookingMode()">‚ùå Exit</button>
                    </div>
                `;

                document.body.appendChild(cookingMode);
                
                // Initialize cooking mode state
                this.cookingState = {
                    currentStep: 0,
                    totalSteps: instructions.length,
                    recipeId: recipeId
                };
                
                this.updateCurrentStep();
                this.initializeCookingEventListeners();
            }

            extractIngredientsFromContent(content) {
                const lines = content.split('\n');
                const ingredients = [];
                let inIngredientsSection = false;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    const lowerLine = trimmedLine.toLowerCase();
                    if (lowerLine.includes('ingredient') || lowerLine.includes('what you need')) {
                        inIngredientsSection = true;
                        continue;
                    }
                    if (lowerLine.includes('instruction') || lowerLine.includes('method') || lowerLine.includes('directions')) {
                        inIngredientsSection = false;
                        continue;
                    }
                    
                    if (inIngredientsSection && trimmedLine) {
                        ingredients.push(trimmedLine);
                    }
                }
                
                return ingredients.length > 0 ? ingredients : ['No ingredients found'];
            }

            extractInstructionsFromContent(content) {
                const lines = content.split('\n');
                const instructions = [];
                let inInstructionsSection = false;
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    const lowerLine = trimmedLine.toLowerCase();
                    if (lowerLine.includes('instruction') || lowerLine.includes('method') || lowerLine.includes('directions') || lowerLine.includes('steps')) {
                        inInstructionsSection = true;
                        continue;
                    }
                    if (lowerLine.includes('ingredient') || lowerLine.includes('what you need')) {
                        inInstructionsSection = false;
                        continue;
                    }
                    
                    if (inInstructionsSection && trimmedLine) {
                        instructions.push(trimmedLine);
                    }
                }
                
                return instructions.length > 0 ? instructions : ['No instructions found'];
            }

            initializeCookingEventListeners() {
                // Add event listeners for ingredient checkboxes
                document.querySelectorAll('.ingredient-checkbox').forEach((checkbox, index) => {
                    checkbox.addEventListener('change', () => {
                        const label = checkbox.nextElementSibling;
                        if (checkbox.checked) {
                            label.classList.add('ingredient-checked');
                        } else {
                            label.classList.remove('ingredient-checked');
                        }
                    });
                });
            }

            updateCurrentStep() {
                // Remove current step highlighting
                document.querySelectorAll('.step-item').forEach(step => {
                    step.classList.remove('step-current');
                });
                
                // Highlight current step
                const currentStepElement = document.getElementById(`step-${this.cookingState.currentStep}`);
                if (currentStepElement) {
                    currentStepElement.classList.add('step-current');
                }
            }

            nextStep() {
                if (this.cookingState.currentStep < this.cookingState.totalSteps - 1) {
                    this.cookingState.currentStep++;
                    this.updateCurrentStep();
                }
            }

            previousStep() {
                if (this.cookingState.currentStep > 0) {
                    this.cookingState.currentStep--;
                    this.updateCurrentStep();
                }
            }

            adjustTextSize(delta) {
                const cookingContent = document.querySelector('.cooking-content');
                if (cookingContent) {
                    const currentSize = parseFloat(getComputedStyle(cookingContent).fontSize);
                    const newSize = Math.max(12, Math.min(24, currentSize + delta));
                    cookingContent.style.fontSize = newSize + 'px';
                }
            }

            exitCookingMode() {
                const cookingMode = document.getElementById('cookingMode');
                if (cookingMode) {
                    cookingMode.remove();
                }
                
                // Re-enable screen lock
                if (navigator.wakeLock) {
                    navigator.wakeLock.release().catch(err => {
                        console.log('Screen lock re-enable failed:', err);
                    });
                }
                
                this.cookingState = null;
            }

            // Social Media & Sharing Methods
            showShareModal(recipeId) {
                const recipe = this.recipes.find(r => r.id === recipeId);
                if (!recipe) return;

                const modal = document.createElement('div');
                modal.className = 'share-modal';
                modal.id = 'shareModal';
                
                modal.innerHTML = `
                    <div class="share-modal-content">
                        <h3>üì§ Share "${this.escapeHtml(recipe.title)}"</h3>
                        <p>Choose how you'd like to share this recipe</p>
                        
                        <div class="share-options">
                            <div class="share-option" data-platform="facebook">
                                üìò Facebook
                            </div>
                            <div class="share-option" data-platform="twitter">
                                üê¶ Twitter
                            </div>
                            <div class="share-option" data-platform="whatsapp">
                                üí¨ WhatsApp
                            </div>
                            <div class="share-option" data-platform="email">
                                üìß Email
                            </div>
                            <div class="share-option" data-platform="copy">
                                üìã Copy Link
                            </div>
                            <div class="share-option" data-platform="qr">
                                üì± QR Code
                            </div>
                        </div>
                        
                        <div class="share-url" id="shareUrl" style="display: none;">
                            <strong>Share URL:</strong><br>
                            <span id="urlText"></span>
                        </div>
                        
                        <div class="qr-code-container" id="qrContainer" style="display: none;">
                            <canvas id="qrCanvas" width="200" height="200"></canvas>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn-secondary" onclick="recipeKeeper.closeShareModal()">Close</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                
                // Add event listeners for share options
                modal.querySelectorAll('.share-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const platform = option.dataset.platform;
                        this.handleShare(recipe, platform);
                    });
                });
            }

            handleShare(recipe, platform) {
                const shareUrl = this.generateShareUrl(recipe);
                const shareText = this.generateShareText(recipe);
                
                switch (platform) {
                    case 'facebook':
                        this.shareToFacebook(recipe, shareUrl, shareText);
                        break;
                    case 'twitter':
                        this.shareToTwitter(recipe, shareUrl, shareText);
                        break;
                    case 'whatsapp':
                        this.shareToWhatsApp(recipe, shareUrl, shareText);
                        break;
                    case 'email':
                        this.shareViaEmail(recipe, shareUrl, shareText);
                        break;
                    case 'copy':
                        this.copyToClipboard(shareUrl);
                        break;
                    case 'qr':
                        this.generateQRCode(recipe, shareUrl);
                        break;
                }
            }

            generateShareUrl(recipe) {
                // Create a shareable URL with recipe data
                const baseUrl = window.location.origin + window.location.pathname;
                const recipeData = {
                    title: recipe.title,
                    content: recipe.content.substring(0, 500), // Limit content for URL
                    type: recipe.type,
                    cuisine: recipe.cuisine,
                    difficulty: recipe.difficulty,
                    cookTime: recipe.cookTime,
                    servings: recipe.servings
                };
                
                const encodedData = btoa(JSON.stringify(recipeData));
                return `${baseUrl}#share=${encodedData}`;
            }

            generateShareText(recipe) {
                let text = `üçΩÔ∏è Check out this amazing recipe: "${recipe.title}"\n\n`;
                
                if (recipe.type) text += `üìù Type: ${recipe.type}\n`;
                if (recipe.cuisine) text += `üåç Cuisine: ${recipe.cuisine}\n`;
                if (recipe.difficulty) text += `‚≠ê Difficulty: ${recipe.difficulty}\n`;
                if (recipe.cookTime) text += `‚è±Ô∏è Cook Time: ${recipe.cookTime}\n`;
                if (recipe.servings) text += `üë• Serves: ${recipe.servings}\n`;
                
                text += `\nüìñ Recipe: ${recipe.content.substring(0, 200)}...`;
                text += `\n\n#Recipe #Cooking #Food`;
                
                return text;
            }

            shareToFacebook(recipe, shareUrl, shareText) {
                const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(shareText)}`;
                window.open(facebookUrl, '_blank', 'width=600,height=400');
                this.closeShareModal();
            }

            shareToTwitter(recipe, shareUrl, shareText) {
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
                window.open(twitterUrl, '_blank', 'width=600,height=400');
                this.closeShareModal();
            }

            shareToWhatsApp(recipe, shareUrl, shareText) {
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText + '\n\n' + shareUrl)}`;
                window.open(whatsappUrl, '_blank');
                this.closeShareModal();
            }

            shareViaEmail(recipe, shareUrl, shareText) {
                const subject = `Recipe: ${recipe.title}`;
                const body = `${shareText}\n\nView full recipe: ${shareUrl}`;
                const emailUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = emailUrl;
                this.closeShareModal();
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showMessage('üìã Link copied to clipboard!', 'success');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showMessage('üìã Link copied to clipboard!', 'success');
                });
                this.closeShareModal();
            }

            generateQRCode(recipe, shareUrl) {
                const qrContainer = document.getElementById('qrContainer');
                const qrCanvas = document.getElementById('qrCanvas');
                const urlText = document.getElementById('urlText');
                
                qrContainer.style.display = 'block';
                urlText.textContent = shareUrl;
                
                // Simple QR code generation (you could use a library like qrcode.js)
                this.drawSimpleQR(shareUrl, qrCanvas);
            }

            drawSimpleQR(text, canvas) {
                // This is a simplified QR-like pattern generator
                // For production, use a proper QR code library
                const ctx = canvas.getContext('2d');
                const size = 200;
                const cellSize = 4;
                const cells = size / cellSize;
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, size, size);
                
                ctx.fillStyle = 'black';
                
                // Create a simple pattern based on the text
                for (let i = 0; i < cells; i++) {
                    for (let j = 0; j < cells; j++) {
                        const hash = this.simpleHash(text + i + j);
                        if (hash % 3 === 0) {
                            ctx.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
                        }
                    }
                }
                
                // Add corner markers
                this.drawCornerMarker(ctx, 0, 0, cellSize);
                this.drawCornerMarker(ctx, cells - 7, 0, cellSize);
                this.drawCornerMarker(ctx, 0, cells - 7, cellSize);
            }

            drawCornerMarker(ctx, x, y, cellSize) {
                const marker = [
                    [1,1,1,1,1,1,1],
                    [1,0,0,0,0,0,1],
                    [1,0,1,1,1,0,1],
                    [1,0,1,1,1,0,1],
                    [1,0,1,1,1,0,1],
                    [1,0,0,0,0,0,1],
                    [1,1,1,1,1,1,1]
                ];
                
                for (let i = 0; i < 7; i++) {
                    for (let j = 0; j < 7; j++) {
                        if (marker[i][j]) {
                            ctx.fillRect((x + j) * cellSize, (y + i) * cellSize, cellSize, cellSize);
                        }
                    }
                }
            }

            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return Math.abs(hash);
            }

            closeShareModal() {
                const modal = document.getElementById('shareModal');
                if (modal) {
                    modal.remove();
                }
            }

            // Export and Import Methods
            exportAllRecipes() {
                const dataStr = JSON.stringify(this.recipes, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `recipe-collection-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                this.showMessage('üì¶ Recipe collection exported successfully!', 'success');
            }

            importFromUrl() {
                const url = document.getElementById('socialMediaUrl').value.trim();
                if (!url) {
                    this.showMessage('Please enter a URL', 'error');
                    return;
                }
                
                this.showLoading('Importing recipe from URL...');
                
                // For now, we'll create a placeholder recipe from the URL
                // In a real implementation, you'd fetch and parse the URL content
                setTimeout(() => {
                    const importedRecipe = {
                        id: Date.now().toString(),
                        title: `Imported Recipe from ${new URL(url).hostname}`,
                        content: `Recipe imported from: ${url}\n\nPlease edit this recipe to add the actual content.`,
                        createdAt: new Date().toISOString(),
                        ingredients: [],
                        instructions: [],
                        servings: '',
                        prepTime: '',
                        cookTime: '',
                        type: '',
                        mainIngredient: '',
                        cuisine: '',
                        difficulty: '',
                        cookTimeCategory: '',
                        dietary: [],
                        rating: 0,
                        isFavorite: false,
                        photo: null,
                        nutrition: {
                            calories: '',
                            protein: '',
                            carbs: '',
                            fat: '',
                            fiber: '',
                            sugar: '',
                            sodium: ''
                        },
                        videoUrl: url,
                        relatedRecipes: [],
                        notes: `Imported from: ${url}`
                    };
                    
                    this.recipes.push(importedRecipe);
                    this.saveRecipes();
                    this.renderRecipes();
                    this.hideLoading();
                    this.showMessage('üì• Recipe imported successfully! Please edit to add content.', 'success');
                    document.getElementById('socialMediaUrl').value = '';
                }, 2000);
            }

            // Initialize file import
            initializeFileImport() {
                const fileInput = document.getElementById('jsonFileInput');
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedRecipes = JSON.parse(e.target.result);
                                if (Array.isArray(importedRecipes)) {
                                    this.importRecipes(importedRecipes);
                                } else {
                                    this.showMessage('Invalid file format', 'error');
                                }
                            } catch (error) {
                                this.showMessage('Error reading file', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                });
            }

            importRecipes(importedRecipes) {
                let importedCount = 0;
                
                importedRecipes.forEach(importedRecipe => {
                    // Check if recipe already exists
                    const exists = this.recipes.some(r => r.title === importedRecipe.title);
                    if (!exists) {
                        // Add unique ID and timestamp
                        importedRecipe.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                        importedRecipe.createdAt = new Date().toISOString();
                        this.recipes.push(importedRecipe);
                        importedCount++;
                    }
                });
                
                this.saveRecipes();
                this.renderRecipes();
                this.showMessage(`üì• Imported ${importedCount} new recipes!`, 'success');
            }

            // Handle shared recipes from URL
            handleSharedRecipe() {
                const hash = window.location.hash;
                if (hash.startsWith('#share=')) {
                    try {
                        const encodedData = hash.substring(7);
                        const recipeData = JSON.parse(atob(encodedData));
                        
                        // Create a new recipe from shared data
                        const sharedRecipe = {
                            id: Date.now().toString(),
                            title: recipeData.title,
                            content: recipeData.content,
                            createdAt: new Date().toISOString(),
                            ingredients: [],
                            instructions: [],
                            servings: recipeData.servings || '',
                            prepTime: '',
                            cookTime: recipeData.cookTime || '',
                            type: recipeData.type || '',
                            mainIngredient: '',
                            cuisine: recipeData.cuisine || '',
                            difficulty: recipeData.difficulty || '',
                            cookTimeCategory: '',
                            dietary: [],
                            rating: 0,
                            isFavorite: false,
                            photo: null,
                            nutrition: {
                                calories: '',
                                protein: '',
                                carbs: '',
                                fat: '',
                                fiber: '',
                                sugar: '',
                                sodium: ''
                            },
                            videoUrl: '',
                            relatedRecipes: [],
                            notes: 'Shared recipe - please review and edit as needed'
                        };
                        
                        // Check if recipe already exists
                        const exists = this.recipes.some(r => r.title === sharedRecipe.title);
                        if (!exists) {
                            this.recipes.push(sharedRecipe);
                            this.saveRecipes();
                            this.renderRecipes();
                            this.showMessage('üì• Shared recipe imported successfully!', 'success');
                            this.switchSection('recipes');
                        } else {
                            this.showMessage('üìã Recipe already exists in your collection', 'info');
                        }
                        
                        // Clear the hash
                        window.location.hash = '';
                    } catch (error) {
                        console.error('Error parsing shared recipe:', error);
                        this.showMessage('‚ùå Error importing shared recipe', 'error');
                    }
                }
            }

            renderCategories() {
                const container = document.getElementById('categoriesContainer');
                
                // Group recipes by categories
                const categories = this.groupRecipesByCategories();
                
                if (Object.keys(categories).length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No Categories Yet</h3>
                            <p>Add some recipes with categories to see them organized here.</p>
                        </div>
                    `;
                    return;
                }

                const categoriesGrid = document.createElement('div');
                categoriesGrid.className = 'categories-grid';

                Object.keys(categories).forEach(categoryType => {
                    const categoryData = categories[categoryType];
                    
                    Object.keys(categoryData).forEach(categoryValue => {
                        const recipes = categoryData[categoryValue];
                        const categoryCard = document.createElement('div');
                        categoryCard.className = 'category-card';
                        
                        const categoryName = this.formatCategoryValue(categoryValue);
                        const categoryTypeName = this.formatCategoryValue(categoryType);
                        
                        let recipesList = '';
                        recipes.forEach(recipe => {
                            recipesList += `
                                <div class="category-recipe-item">
                                    <span class="category-recipe-title" onclick="recipeKeeper.viewRecipe('${recipe.id}')">
                                        ${this.escapeHtml(recipe.title)}
                                    </span>
                                    <div class="category-recipe-actions">
                                        <button class="btn-tiny btn-view" onclick="recipeKeeper.viewRecipe('${recipe.id}')">View</button>
                                        <button class="btn-tiny btn-edit" onclick="recipeKeeper.editRecipe('${recipe.id}')">Edit</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        categoryCard.innerHTML = `
                            <div class="category-header">
                                <span class="category-name">${categoryName}</span>
                                <span class="category-count">${recipes.length} recipe${recipes.length !== 1 ? 's' : ''}</span>
                            </div>
                            <div style="color: var(--soft-brown); font-size: 0.9rem; margin-bottom: 15px;">
                                ${categoryTypeName}
                            </div>
                            <div class="category-recipes">
                                ${recipesList}
                            </div>
                        `;
                        
                        categoriesGrid.appendChild(categoryCard);
                    });
                });

                container.innerHTML = '';
                container.appendChild(categoriesGrid);
            }

            groupRecipesByCategories() {
                const categories = {};
                
                this.recipes.forEach(recipe => {
                    // Group by type
                    if (recipe.type) {
                        if (!categories.type) categories.type = {};
                        if (!categories.type[recipe.type]) categories.type[recipe.type] = [];
                        categories.type[recipe.type].push(recipe);
                    }
                    
                    // Group by main ingredient
                    if (recipe.mainIngredient) {
                        if (!categories.mainIngredient) categories.mainIngredient = {};
                        if (!categories.mainIngredient[recipe.mainIngredient]) categories.mainIngredient[recipe.mainIngredient] = [];
                        categories.mainIngredient[recipe.mainIngredient].push(recipe);
                    }
                    
                    // Group by cuisine
                    if (recipe.cuisine) {
                        if (!categories.cuisine) categories.cuisine = {};
                        if (!categories.cuisine[recipe.cuisine]) categories.cuisine[recipe.cuisine] = [];
                        categories.cuisine[recipe.cuisine].push(recipe);
                    }
                    
                    // Group by difficulty
                    if (recipe.difficulty) {
                        if (!categories.difficulty) categories.difficulty = {};
                        if (!categories.difficulty[recipe.difficulty]) categories.difficulty[recipe.difficulty] = [];
                        categories.difficulty[recipe.difficulty].push(recipe);
                    }
                    
                    // Group by cooking time
                    if (recipe.cookTimeCategory) {
                        if (!categories.cookTimeCategory) categories.cookTimeCategory = {};
                        if (!categories.cookTimeCategory[recipe.cookTimeCategory]) categories.cookTimeCategory[recipe.cookTimeCategory] = [];
                        categories.cookTimeCategory[recipe.cookTimeCategory].push(recipe);
                    }
                    
                    // Group by dietary restrictions
                    if (recipe.dietary && recipe.dietary.length > 0) {
                        if (!categories.dietary) categories.dietary = {};
                        recipe.dietary.forEach(diet => {
                            if (!categories.dietary[diet]) categories.dietary[diet] = [];
                            categories.dietary[diet].push(recipe);
                        });
                    }
                });
                
                return categories;
            }

            viewRecipe(id) {
                const recipe = this.recipes.find(r => r.id === id);
                if (recipe) {
                    this.showRecipeModal(recipe);
                }
            }

            showRecipeModal(recipe) {
                document.getElementById('modalTitle').textContent = recipe.title;
                
                let content = '';
                
                // Add meta information
                if (recipe.servings || recipe.prepTime || recipe.cookTime) {
                    content += '<div style="margin-bottom: 25px; padding: 15px; background: var(--light-sage); border-radius: 10px; color: white;">';
                    if (recipe.servings) content += `<span style="margin-right: 20px;">${recipe.servings}</span>`;
                    if (recipe.prepTime) content += `<span style="margin-right: 20px;">${recipe.prepTime}</span>`;
                    if (recipe.cookTime) content += `<span>${recipe.cookTime}</span>`;
                    content += '</div>';
                }
                
                // Add ingredients
                if (recipe.ingredients.length > 0) {
                    content += '<h4>Ingredients</h4><ul>';
                    recipe.ingredients.forEach(ingredient => {
                        content += `<li>${ingredient}</li>`;
                    });
                    content += '</ul>';
                }
                
                // Add instructions
                if (recipe.instructions.length > 0) {
                    content += '<h4>Instructions</h4><ol>';
                    recipe.instructions.forEach(instruction => {
                        content += `<li>${instruction}</li>`;
                    });
                    content += '</ol>';
                }
                
                // If no structured data, show original content with rich text support
                if (recipe.ingredients.length === 0 && recipe.instructions.length === 0) {
                    content += '<div class="recipe-content">' + recipe.content + '</div>';
                }
                
                document.getElementById('modalContent').innerHTML = content;
                document.getElementById('recipeModal').style.display = 'block';
            }

            closeModal() {
                document.getElementById('recipeModal').style.display = 'none';
            }

            handleSearch(query) {
                const filtered = query.trim() === '' ? this.recipes : 
                    this.recipes.filter(recipe => 
                        recipe.title.toLowerCase().includes(query.toLowerCase()) ||
                        recipe.content.toLowerCase().includes(query.toLowerCase()) ||
                        (recipe.type && recipe.type.toLowerCase().includes(query.toLowerCase())) ||
                        (recipe.mainIngredient && recipe.mainIngredient.toLowerCase().includes(query.toLowerCase())) ||
                        (recipe.cuisine && recipe.cuisine.toLowerCase().includes(query.toLowerCase())) ||
                        (recipe.dietary && recipe.dietary.some(d => d.toLowerCase().includes(query.toLowerCase())))
                    );
                this.renderRecipes(filtered);
            }

            getSelectedDietaryRestrictions() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                return Array.from(checkboxes).map(cb => cb.value);
            }

            applyFilters() {
                const filters = {
                    type: document.getElementById('filterType').value,
                    mainIngredient: document.getElementById('filterIngredient').value,
                    cuisine: document.getElementById('filterCuisine').value,
                    difficulty: document.getElementById('filterDifficulty').value,
                    cookTimeCategory: document.getElementById('filterTime').value,
                    dietary: document.getElementById('filterDietary').value
                };

                let filtered = this.recipes;

                // Apply each filter
                Object.keys(filters).forEach(key => {
                    if (filters[key]) {
                        if (key === 'dietary') {
                            filtered = filtered.filter(recipe => 
                                recipe.dietary && recipe.dietary.includes(filters[key])
                            );
                        } else {
                            filtered = filtered.filter(recipe => recipe[key] === filters[key]);
                        }
                    }
                });

                this.renderRecipes(filtered);
            }

            clearFilters() {
                // Reset all filter controls
                document.getElementById('filterType').value = '';
                document.getElementById('filterIngredient').value = '';
                document.getElementById('filterCuisine').value = '';
                document.getElementById('filterDifficulty').value = '';
                document.getElementById('filterTime').value = '';
                document.getElementById('filterDietary').value = '';
                document.getElementById('searchInput').value = '';

                // Show all recipes
                this.renderRecipes();
            }

            handleSort(sortBy) {
                let sorted = [...this.recipes];

                switch(sortBy) {
                    case 'newest':
                        sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        break;
                    case 'oldest':
                        sorted.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                        break;
                    case 'title-az':
                        sorted.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'title-za':
                        sorted.sort((a, b) => b.title.localeCompare(a.title));
                        break;
                    case 'difficulty-easy':
                        const difficultyOrder = { 'easy': 1, 'medium': 2, 'hard': 3 };
                        sorted.sort((a, b) => (difficultyOrder[a.difficulty] || 4) - (difficultyOrder[b.difficulty] || 4));
                        break;
                    case 'difficulty-hard':
                        const difficultyOrderRev = { 'hard': 1, 'medium': 2, 'easy': 3 };
                        sorted.sort((a, b) => (difficultyOrderRev[a.difficulty] || 4) - (difficultyOrderRev[b.difficulty] || 4));
                        break;
                    case 'time-short':
                        const timeOrder = { 'under-15': 1, '15-30': 2, '30-60': 3, '1-2-hours': 4, 'over-2-hours': 5 };
                        sorted.sort((a, b) => (timeOrder[a.cookTimeCategory] || 6) - (timeOrder[b.cookTimeCategory] || 6));
                        break;
                    case 'time-long':
                        const timeOrderRev = { 'over-2-hours': 1, '1-2-hours': 2, '30-60': 3, '15-30': 4, 'under-15': 5 };
                        sorted.sort((a, b) => (timeOrderRev[a.cookTimeCategory] || 6) - (timeOrderRev[b.cookTimeCategory] || 6));
                        break;
                }

                this.renderRecipes(sorted);
            }

            renderRecipes(recipesToRender = this.recipes) {
                const container = document.getElementById('recipesContainer');
                
                if (recipesToRender.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>${this.recipes.length === 0 ? 'Your Recipe Collection Awaits' : 'No Recipes Found'}</h3>
                            <p>${this.recipes.length === 0 ? 
                                'Start by adding your first recipe using the "Add Recipe" tab above.' : 
                                'Try adjusting your search terms.'}</p>
                        </div>
                    `;
                    return;
                }

                const recipesGrid = document.createElement('div');
                recipesGrid.className = 'recipes-grid';
                
                recipesToRender.forEach(recipe => {
                    const card = document.createElement('div');
                    card.className = 'recipe-card';
                    
                    // Create preview from HTML content
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = recipe.content;
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    const preview = textContent.substring(0, 150) + (textContent.length > 150 ? '...' : '');
                    
                    // Build category tags
                    const categoryTags = this.buildCategoryTags(recipe);
                    
                    // Build additional features display
                    const photoDisplay = recipe.photo ? `<img src="${recipe.photo}" class="recipe-photo" alt="${this.escapeHtml(recipe.title)}">` : '';
                    const ratingDisplay = recipe.rating > 0 ? `<div class="recipe-rating"><span class="stars">${'‚òÖ'.repeat(recipe.rating)}</span><span>(${recipe.rating}/5)</span></div>` : '';
                    const favoriteDisplay = recipe.isFavorite ? '<div class="recipe-favorite">‚≠ê</div>' : '';
                    const videoDisplay = recipe.videoUrl ? '<span class="recipe-video">üìπ Video</span>' : '';
                    
                    card.innerHTML = `
                        ${favoriteDisplay}
                        ${photoDisplay}
                        <h3>${this.escapeHtml(recipe.title)}</h3>
                        ${ratingDisplay}
                        <div class="recipe-categories">
                            ${categoryTags}
                        </div>
                        <div class="recipe-meta">
                            ${recipe.servings ? `<span>${this.escapeHtml(recipe.servings)}</span>` : ''}
                            ${recipe.prepTime ? `<span>${this.escapeHtml(recipe.prepTime)}</span>` : ''}
                            ${recipe.cookTime ? `<span>${this.escapeHtml(recipe.cookTime)}</span>` : ''}
                            ${videoDisplay}
                        </div>
                        <div class="recipe-preview recipe-content">${preview}</div>
                        <div class="recipe-actions">
                            <button class="btn-small btn-edit" data-action="view" data-id="${recipe.id}">View</button>
                            <button class="btn-small btn-edit" data-action="cook" data-id="${recipe.id}">üë®‚Äçüç≥ Cook</button>
                            <button class="btn-small btn-edit" data-action="share" data-id="${recipe.id}">üì§ Share</button>
                            <button class="btn-small btn-edit" data-action="edit" data-id="${recipe.id}">Edit</button>
                            <button class="btn-small btn-delete" data-action="delete" data-id="${recipe.id}">Delete</button>
                        </div>
                    `;
                    
                    // Add event listeners for buttons
                    const viewBtn = card.querySelector('[data-action="view"]');
                    const cookBtn = card.querySelector('[data-action="cook"]');
                    const shareBtn = card.querySelector('[data-action="share"]');
                    const editBtn = card.querySelector('[data-action="edit"]');
                    const deleteBtn = card.querySelector('[data-action="delete"]');
                    
                    viewBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.viewRecipe(recipe.id);
                    });
                    
                    cookBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.startCookingMode(recipe.id);
                    });
                    
                    shareBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showShareModal(recipe.id);
                    });
                    
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.editRecipe(recipe.id);
                    });
                    
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteRecipe(recipe.id);
                    });
                    
                    // Make card clickable to view recipe
                    card.style.cursor = 'pointer';
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('.recipe-actions')) {
                            this.viewRecipe(recipe.id);
                        }
                    });
                    
                    recipesGrid.appendChild(card);
                });
                
                container.innerHTML = '';
                container.appendChild(recipesGrid);
            }

            resetForm() {
                document.getElementById('recipeForm').reset();
                // Clear rich text editor
                this.clearRichTextEditor();
                // Clear all checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                // Clear rating
                this.setRating(0);
                // Clear photo preview
                document.getElementById('photoPreview').innerHTML = '';
                // Clear nutrition fields
                ['calories', 'protein', 'carbs', 'fat', 'fiber', 'sugar', 'sodium'].forEach(field => {
                    document.getElementById(field).value = '';
                });
                this.currentEditId = null;
            }

            loadRecipes() {
                const saved = localStorage.getItem('recipe-keeper-recipes');
                return saved ? JSON.parse(saved) : [];
            }

            loadShoppingList() {
                const saved = localStorage.getItem('recipe-keeper-shopping-list');
                return saved ? JSON.parse(saved) : [];
            }

            saveShoppingList() {
                localStorage.setItem('recipe-keeper-shopping-list', JSON.stringify(this.shoppingList));
            }

            // Rich Text Editor Methods
            initializeRichTextEditor() {
                const editor = document.getElementById('recipeText');
                if (!editor) return;

                // Add event listeners for format buttons
                document.querySelectorAll('.format-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const command = btn.dataset.command;
                        this.executeFormatCommand(command);
                        this.updateFormatButtons();
                    });
                });

                // Update format buttons on selection change
                editor.addEventListener('keyup', () => this.updateFormatButtons());
                editor.addEventListener('mouseup', () => this.updateFormatButtons());
                editor.addEventListener('focus', () => this.updateFormatButtons());

                // Handle paste events to clean up formatting
                editor.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    document.execCommand('insertText', false, text);
                });
            }

            executeFormatCommand(command) {
                const editor = document.getElementById('recipeText');
                editor.focus();

                if (command === 'removeFormat') {
                    document.execCommand('removeFormat', false, null);
                } else {
                    document.execCommand(command, false, null);
                }
            }

            updateFormatButtons() {
                const editor = document.getElementById('recipeText');
                if (!editor) return;

                document.querySelectorAll('.format-btn').forEach(btn => {
                    const command = btn.dataset.command;
                    let isActive = false;

                    if (command === 'bold' || command === 'italic' || command === 'underline') {
                        isActive = document.queryCommandState(command);
                    } else if (command === 'insertUnorderedList' || command === 'insertOrderedList') {
                        isActive = document.queryCommandState(command);
                    } else if (command.startsWith('justify')) {
                        const currentAlign = document.queryCommandValue('justify');
                        isActive = currentAlign === command.replace('justify', '').toLowerCase();
                    }

                    btn.classList.toggle('active', isActive);
                });
            }

            getRichTextContent() {
                const editor = document.getElementById('recipeText');
                return editor ? editor.innerHTML : '';
            }

            setRichTextContent(html) {
                const editor = document.getElementById('recipeText');
                if (editor) {
                    editor.innerHTML = html;
                }
            }

            clearRichTextEditor() {
                const editor = document.getElementById('recipeText');
                if (editor) {
                    editor.innerHTML = '';
                }
            }

            // Unit Conversion Methods
            convertUnits() {
                const editor = document.getElementById('recipeText');
                if (!editor) return;

                const content = editor.innerHTML;
                if (!content.trim()) {
                    this.showMessage('Please add some content to convert', 'error');
                    return;
                }

                // Show conversion modal
                document.getElementById('unitConversionModal').style.display = 'block';
                this.generateConversionPreview(content);
                
                // Add event listeners for conversion type changes
                document.querySelectorAll('input[name="conversionType"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.generateConversionPreview(content);
                    });
                });
            }

            generateConversionPreview(content) {
                const conversionType = document.querySelector('input[name="conversionType"]:checked').value;
                const conversions = this.findConversions(content, conversionType);
                
                const previewContainer = document.getElementById('conversionPreview');
                
                if (conversions.length === 0) {
                    previewContainer.innerHTML = '<p style="color: var(--soft-brown); font-style: italic;">No convertible units found in this recipe.</p>';
                    return;
                }

                let html = '';
                conversions.forEach(conversion => {
                    html += `
                        <div class="conversion-item">
                            <span class="conversion-original">${conversion.original}</span>
                            <span class="conversion-arrow">‚Üí</span>
                            <span class="conversion-result">${conversion.converted}</span>
                        </div>
                    `;
                });

                previewContainer.innerHTML = html;
            }

            findConversions(content, conversionType) {
                const conversions = [];
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const text = tempDiv.textContent || tempDiv.innerText || '';

                // Define conversion patterns
                const patterns = this.getConversionPatterns(conversionType);
                
                patterns.forEach(pattern => {
                    const regex = new RegExp(pattern.regex, 'gi');
                    let match;
                    
                    while ((match = regex.exec(text)) !== null) {
                        const original = match[0];
                        const converted = this.convertMeasurement(original, pattern);
                        
                        if (converted && converted !== original) {
                            conversions.push({
                                original: original,
                                converted: converted,
                                pattern: pattern
                            });
                        }
                    }
                });

                return conversions;
            }

            getConversionPatterns(conversionType) {
                if (conversionType === 'us-to-metric') {
                    return [
                        // Volume conversions
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(cups?|cup)\\b', type: 'volume', from: 'cup', to: 'ml', factor: 236.588 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(tablespoons?|tbsp|T)\\b', type: 'volume', from: 'tbsp', to: 'ml', factor: 14.7868 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(teaspoons?|tsp|t)\\b', type: 'volume', from: 'tsp', to: 'ml', factor: 4.92892 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(fluid ounces?|fl oz)\\b', type: 'volume', from: 'fl oz', to: 'ml', factor: 29.5735 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(pints?|pt)\\b', type: 'volume', from: 'pint', to: 'ml', factor: 473.176 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(quarts?|qt)\\b', type: 'volume', from: 'quart', to: 'ml', factor: 946.353 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(gallons?|gal)\\b', type: 'volume', from: 'gallon', to: 'l', factor: 3.78541 },
                        
                        // Weight conversions
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(pounds?|lbs?|lb)\\b', type: 'weight', from: 'lb', to: 'kg', factor: 0.453592 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(ounces?|oz)\\b', type: 'weight', from: 'oz', to: 'g', factor: 28.3495 },
                        
                        // Temperature conversions
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*¬∞?F\\b', type: 'temperature', from: 'F', to: 'C', factor: 'fahrenheit' },
                        
                        // Length conversions
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(inches?|in)\\b', type: 'length', from: 'in', to: 'cm', factor: 2.54 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(feet?|ft)\\b', type: 'length', from: 'ft', to: 'cm', factor: 30.48 }
                    ];
                } else {
                    return [
                        // Volume conversions
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(ml|milliliters?)\\b', type: 'volume', from: 'ml', to: 'cup', factor: 0.00422675 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(l|liters?)\\b', type: 'volume', from: 'l', to: 'cup', factor: 4.22675 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(dl|deciliters?)\\b', type: 'volume', from: 'dl', to: 'cup', factor: 0.422675 },
                        
                        // Weight conversions
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(kg|kilograms?)\\b', type: 'weight', from: 'kg', to: 'lb', factor: 2.20462 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(g|grams?)\\b', type: 'weight', from: 'g', to: 'oz', factor: 0.035274 },
                        
                        // Temperature conversions
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*¬∞?C\\b', type: 'temperature', from: 'C', to: 'F', factor: 'celsius' },
                        
                        // Length conversions
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(cm|centimeters?)\\b', type: 'length', from: 'cm', to: 'in', factor: 0.393701 },
                        { regex: '\\b(\\d+(?:\\.\\d+)?)\\s*(mm|millimeters?)\\b', type: 'length', from: 'mm', to: 'in', factor: 0.0393701 }
                    ];
                }
            }

            convertMeasurement(original, pattern) {
                const match = original.match(new RegExp(pattern.regex, 'i'));
                if (!match) return original;

                const value = parseFloat(match[1]);
                if (isNaN(value)) return original;

                let convertedValue;
                let unit;

                if (pattern.type === 'temperature') {
                    if (pattern.from === 'F') {
                        convertedValue = Math.round((value - 32) * 5/9);
                        unit = '¬∞C';
                    } else {
                        convertedValue = Math.round(value * 9/5 + 32);
                        unit = '¬∞F';
                    }
                } else {
                    convertedValue = value * pattern.factor;
                    
                    if (convertedValue < 1 && pattern.type === 'volume') {
                        convertedValue = Math.round(convertedValue * 100) / 100;
                    } else if (convertedValue < 1 && pattern.type === 'weight') {
                        convertedValue = Math.round(convertedValue * 100) / 100;
                    } else {
                        convertedValue = Math.round(convertedValue * 10) / 10;
                    }
                    
                    unit = pattern.to;
                }

                return `${convertedValue} ${unit}`;
            }

            applyUnitConversion() {
                const editor = document.getElementById('recipeText');
                if (!editor) return;

                const conversionType = document.querySelector('input[name="conversionType"]:checked').value;
                const content = editor.innerHTML;
                const conversions = this.findConversions(content, conversionType);

                if (conversions.length === 0) {
                    this.showMessage('No conversions to apply', 'info');
                    return;
                }

                let newContent = content;
                conversions.forEach(conversion => {
                    const regex = new RegExp(conversion.pattern.regex, 'gi');
                    newContent = newContent.replace(regex, conversion.converted);
                });

                editor.innerHTML = newContent;
                this.closeUnitConversionModal();
                this.showMessage(`‚úÖ Converted ${conversions.length} measurements!`, 'success');
            }

            closeUnitConversionModal() {
                document.getElementById('unitConversionModal').style.display = 'none';
            }

            // Website Import Methods
            async importFromWebsite() {
                const url = document.getElementById('websiteUrl').value.trim();
                if (!url) {
                    this.showMessage('Please enter a website URL', 'error');
                    return;
                }

                // Show import modal
                document.getElementById('websiteImportModal').style.display = 'block';
                document.getElementById('importStatus').style.display = 'block';
                document.getElementById('importResults').style.display = 'none';

                try {
                    // Simulate website analysis (in a real implementation, you'd use a CORS proxy or backend service)
                    await this.analyzeWebsite(url);
                } catch (error) {
                    this.showMessage('Error importing from website: ' + error.message, 'error');
                    this.closeWebsiteImportModal();
                }
            }

            async analyzeWebsite(url) {
                // Simulate website analysis with a delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // In a real implementation, you would:
                // 1. Use a CORS proxy or backend service to fetch the webpage
                // 2. Parse the HTML to extract recipe data using structured data (JSON-LD, microdata)
                // 3. Fall back to content analysis if no structured data is found

                // For demo purposes, we'll simulate finding a recipe
                const mockRecipe = this.generateMockRecipeFromUrl(url);
                
                document.getElementById('importStatus').style.display = 'none';
                document.getElementById('importResults').style.display = 'block';
                document.getElementById('importedTitle').textContent = mockRecipe.title;
                document.getElementById('importedContent').innerHTML = mockRecipe.content;
                
                this.currentImportedRecipe = mockRecipe;
            }

            generateMockRecipeFromUrl(url) {
                const domain = new URL(url).hostname;
                const recipeTemplates = {
                    'allrecipes.com': {
                        title: 'Classic Chocolate Chip Cookies',
                        content: `
                            <h3>Ingredients</h3>
                            <ul>
                                <li>2 1/4 cups all-purpose flour</li>
                                <li>1 tsp baking soda</li>
                                <li>1 tsp salt</li>
                                <li>1 cup butter, softened</li>
                                <li>3/4 cup granulated sugar</li>
                                <li>3/4 cup packed brown sugar</li>
                                <li>2 large eggs</li>
                                <li>2 tsp vanilla extract</li>
                                <li>2 cups chocolate chips</li>
                            </ul>
                            <h3>Instructions</h3>
                            <ol>
                                <li>Preheat oven to 375¬∞F (190¬∞C).</li>
                                <li>Mix flour, baking soda, and salt in a bowl.</li>
                                <li>Cream butter and sugars until fluffy.</li>
                                <li>Beat in eggs and vanilla.</li>
                                <li>Gradually blend in flour mixture.</li>
                                <li>Stir in chocolate chips.</li>
                                <li>Drop rounded tablespoons onto ungreased cookie sheets.</li>
                                <li>Bake 9-11 minutes until golden brown.</li>
                            </ol>
                        `
                    },
                    'foodnetwork.com': {
                        title: 'Perfect Pancakes',
                        content: `
                            <h3>Ingredients</h3>
                            <ul>
                                <li>1 1/2 cups all-purpose flour</li>
                                <li>3 1/2 tsp baking powder</li>
                                <li>1 tsp salt</li>
                                <li>1 tbsp white sugar</li>
                                <li>1 1/4 cups milk</li>
                                <li>1 egg</li>
                                <li>3 tbsp butter, melted</li>
                            </ul>
                            <h3>Instructions</h3>
                            <ol>
                                <li>In a large bowl, sift together flour, baking powder, salt and sugar.</li>
                                <li>Make a well in the center and pour in milk, egg and melted butter.</li>
                                <li>Mix until smooth.</li>
                                <li>Heat a lightly oiled griddle or frying pan over medium-high heat.</li>
                                <li>Pour or scoop the batter onto the griddle, using approximately 1/4 cup for each pancake.</li>
                                <li>Brown on both sides and serve hot.</li>
                            </ol>
                        `
                    }
                };

                return recipeTemplates[domain] || {
                    title: `Recipe from ${domain}`,
                    content: `
                        <p><strong>Note:</strong> This is a simulated import from ${domain}.</p>
                        <p>In a real implementation, this would contain the actual recipe data extracted from the website.</p>
                        <p>Please edit this content to add your recipe details.</p>
                    `
                };
            }

            editImportedRecipe() {
                // Switch to add recipe section with pre-filled data
                this.switchSection('import');
                document.getElementById('recipeTitle').value = this.currentImportedRecipe.title;
                this.setRichTextContent(this.currentImportedRecipe.content);
                this.closeWebsiteImportModal();
            }

            confirmImport() {
                if (!this.currentImportedRecipe) return;

                const recipe = {
                    id: Date.now().toString(),
                    title: this.currentImportedRecipe.title,
                    content: this.currentImportedRecipe.content,
                    createdAt: new Date().toISOString(),
                    ingredients: [],
                    instructions: [],
                    servings: '',
                    prepTime: '',
                    cookTime: '',
                    type: '',
                    mainIngredient: '',
                    cuisine: '',
                    difficulty: '',
                    cookTimeCategory: '',
                    dietary: [],
                    rating: 0,
                    isFavorite: false,
                    photo: null,
                    nutrition: {
                        calories: '',
                        protein: '',
                        carbs: '',
                        fat: '',
                        fiber: '',
                        sugar: '',
                        sodium: ''
                    },
                    videoUrl: '',
                    relatedRecipes: [],
                    notes: `Imported from website`
                };

                this.recipes.push(recipe);
                this.saveRecipes();
                this.renderRecipes();
                this.closeWebsiteImportModal();
                this.showMessage('‚úÖ Recipe imported successfully!', 'success');
                document.getElementById('websiteUrl').value = '';
            }

            closeWebsiteImportModal() {
                document.getElementById('websiteImportModal').style.display = 'none';
                this.currentImportedRecipe = null;
            }

            // OCR Scanning Methods
            startCameraScan() {
                document.getElementById('ocrScanModal').style.display = 'block';
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('ocrResults').style.display = 'none';

                this.startCamera();
            }

            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    const video = document.getElementById('cameraVideo');
                    video.srcObject = stream;
                    this.cameraStream = stream;
                } catch (error) {
                    this.showMessage('Camera access denied. Please use file upload instead.', 'error');
                    this.closeOCRModal();
                }
            }

            capturePhoto() {
                const video = document.getElementById('cameraVideo');
                const canvas = document.getElementById('cameraCanvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg');
                this.currentImageData = imageData;
                
                // Show preview
                document.getElementById('previewImage').src = imageData;
                document.getElementById('cameraContainer').style.display = 'none';
                document.getElementById('imagePreview').style.display = 'block';
            }

            stopCamera() {
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                }
                document.getElementById('cameraContainer').style.display = 'none';
            }

            retakePhoto() {
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('ocrResults').style.display = 'none';
            }

            async processImage() {
                if (!this.currentImageData) {
                    this.showMessage('No image to process', 'error');
                    return;
                }

                this.showLoading('Extracting text from image...');
                
                try {
                    // In a real implementation, you would use Tesseract.js or a similar OCR library
                    // For demo purposes, we'll simulate OCR processing
                    const extractedText = await this.simulateOCR(this.currentImageData);
                    
                    document.getElementById('extractedText').value = extractedText;
                    document.getElementById('imagePreview').style.display = 'none';
                    document.getElementById('ocrResults').style.display = 'block';
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    this.showMessage('Error processing image: ' + error.message, 'error');
                }
            }

            async simulateOCR(imageData) {
                // Simulate OCR processing delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Return mock extracted text
                return `Chocolate Chip Cookies

Ingredients:
- 2 1/4 cups all-purpose flour
- 1 tsp baking soda
- 1 tsp salt
- 1 cup butter, softened
- 3/4 cup granulated sugar
- 3/4 cup packed brown sugar
- 2 large eggs
- 2 tsp vanilla extract
- 2 cups chocolate chips

Instructions:
1. Preheat oven to 375¬∞F (190¬∞C)
2. Mix flour, baking soda, and salt in a bowl
3. Cream butter and sugars until fluffy
4. Beat in eggs and vanilla
5. Gradually blend in flour mixture
6. Stir in chocolate chips
7. Drop rounded tablespoons onto ungreased cookie sheets
8. Bake 9-11 minutes until golden brown

Note: This is simulated OCR text. In a real implementation, this would be the actual text extracted from your image.`;
            }

            editExtractedText() {
                // Allow user to edit the extracted text
                const textarea = document.getElementById('extractedText');
                textarea.focus();
                textarea.select();
            }

            createRecipeFromOCR() {
                const extractedText = document.getElementById('extractedText').value.trim();
                if (!extractedText) {
                    this.showMessage('No text to create recipe from', 'error');
                    return;
                }

                // Switch to add recipe section with OCR text
                this.switchSection('import');
                document.getElementById('recipeTitle').value = 'Scanned Recipe';
                this.setRichTextContent(`<pre>${this.escapeHtml(extractedText)}</pre>`);
                this.closeOCRModal();
                this.showMessage('‚úÖ OCR text loaded into recipe editor. Please edit and save.', 'success');
            }

            closeOCRModal() {
                this.stopCamera();
                document.getElementById('ocrScanModal').style.display = 'none';
                this.currentImageData = null;
            }

            // Initialize OCR file handling
            initializeOCRFileHandling() {
                const fileInput = document.getElementById('ocrFileInput');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        this.processOCRFiles(files);
                    }
                });
            }

            async processOCRFiles(files) {
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        await this.processImageFile(file);
                    } else if (file.type === 'application/pdf') {
                        this.showMessage('PDF processing not yet implemented. Please use image files.', 'info');
                    }
                }
            }

            async processImageFile(file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    this.currentImageData = e.target.result;
                    
                    // Show OCR modal with image
                    document.getElementById('ocrScanModal').style.display = 'block';
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('cameraContainer').style.display = 'none';
                    document.getElementById('ocrResults').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }

            // Shopping List Methods
            initializeShoppingList() {
                this.renderShoppingList();
                
                // Add event listeners for shopping options
                document.getElementById('groupByAisle')?.addEventListener('change', () => this.renderShoppingList());
                document.getElementById('showQuantities')?.addEventListener('change', () => this.renderShoppingList());
                document.getElementById('markCompleted')?.addEventListener('change', () => this.renderShoppingList());
            }

            generateShoppingList() {
                if (this.recipes.length === 0) {
                    this.showMessage('No recipes available to generate shopping list', 'error');
                    return;
                }

                // Show recipe selection modal
                this.showRecipeSelectionModal();
            }

            showRecipeSelectionModal() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'recipeSelectionModal';
                modal.style.display = 'block';
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>üõí Select Recipes for Shopping List</h3>
                            <button class="close-btn" onclick="recipeKeeper.closeRecipeSelectionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>Choose which recipes to include in your shopping list:</p>
                            <div class="recipe-selection-list">
                                ${this.recipes.map(recipe => `
                                    <label class="recipe-selection-item">
                                        <input type="checkbox" value="${recipe.id}" checked>
                                        <div class="recipe-info">
                                            <strong>${this.escapeHtml(recipe.title)}</strong>
                                            <span class="recipe-meta">
                                                ${recipe.servings ? `${recipe.servings} ‚Ä¢ ` : ''}
                                                ${recipe.cookTime ? `${recipe.cookTime} ‚Ä¢ ` : ''}
                                                ${recipe.type || 'Uncategorized'}
                                            </span>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="recipeKeeper.closeRecipeSelectionModal()">Cancel</button>
                            <button class="btn-primary" onclick="recipeKeeper.generateListFromSelected()">Generate List</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            closeRecipeSelectionModal() {
                const modal = document.getElementById('recipeSelectionModal');
                if (modal) {
                    modal.remove();
                }
            }

            generateListFromSelected() {
                const selectedRecipes = Array.from(document.querySelectorAll('#recipeSelectionModal input[type="checkbox"]:checked'))
                    .map(checkbox => this.recipes.find(r => r.id === checkbox.value))
                    .filter(recipe => recipe);

                if (selectedRecipes.length === 0) {
                    this.showMessage('Please select at least one recipe', 'error');
                    return;
                }

                // Clear existing shopping list
                this.shoppingList = [];

                // Extract ingredients from selected recipes
                selectedRecipes.forEach(recipe => {
                    const ingredients = recipe.ingredients.length > 0 ? recipe.ingredients : 
                        this.extractIngredientsFromContent(recipe.content);
                    
                    ingredients.forEach(ingredient => {
                        if (ingredient.trim()) {
                            this.addShoppingItem(ingredient.trim(), recipe.title);
                        }
                    });
                });

                this.saveShoppingList();
                this.renderShoppingList();
                this.closeRecipeSelectionModal();
                this.showMessage(`üõí Shopping list generated from ${selectedRecipes.length} recipes!`, 'success');
            }

            addShoppingItem(ingredient, sourceRecipe = 'Manual') {
                // Parse ingredient to extract name and quantity
                const parsed = this.parseIngredient(ingredient);
                
                // Check if item already exists
                const existingItem = this.shoppingList.find(item => 
                    item.name.toLowerCase() === parsed.name.toLowerCase()
                );

                if (existingItem) {
                    // Combine quantities if they exist
                    if (parsed.quantity && existingItem.quantity) {
                        existingItem.quantity += ` + ${parsed.quantity}`;
                    } else if (parsed.quantity) {
                        existingItem.quantity = parsed.quantity;
                    }
                    existingItem.sources.push(sourceRecipe);
                } else {
                    this.shoppingList.push({
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        name: parsed.name,
                        quantity: parsed.quantity || '',
                        aisle: this.detectAisle(parsed.name),
                        completed: false,
                        sources: [sourceRecipe],
                        addedAt: new Date().toISOString()
                    });
                }
            }

            parseIngredient(ingredient) {
                // Simple ingredient parsing - extract quantity and name
                const quantityRegex = /^(\d+(?:\/\d+)?(?:\s+\d+\/\d+)?(?:\s*[a-zA-Z]+)?)\s+(.+)$/;
                const match = ingredient.match(quantityRegex);
                
                if (match) {
                    return {
                        quantity: match[1].trim(),
                        name: match[2].trim()
                    };
                } else {
                    return {
                        quantity: '',
                        name: ingredient
                    };
                }
            }

            detectAisle(ingredientName) {
                const name = ingredientName.toLowerCase();
                
                // Produce
                if (name.match(/\b(apple|banana|orange|lettuce|tomato|onion|garlic|carrot|potato|pepper|broccoli|spinach|celery|cucumber|avocado|lemon|lime|grape|berry|fruit|vegetable|herb|mint|basil|parsley|cilantro)\b/)) {
                    return 'produce';
                }
                
                // Dairy & Eggs
                if (name.match(/\b(milk|cheese|butter|yogurt|cream|egg|dairy|sour cream|cottage cheese|mozzarella|cheddar|parmesan)\b/)) {
                    return 'dairy';
                }
                
                // Meat & Seafood
                if (name.match(/\b(chicken|beef|pork|fish|salmon|tuna|shrimp|crab|lobster|turkey|lamb|bacon|sausage|ham|meat|seafood)\b/)) {
                    return 'meat';
                }
                
                // Bakery
                if (name.match(/\b(bread|bagel|muffin|croissant|roll|bun|cake|cookie|pie|pastry|dough|flour|yeast)\b/)) {
                    return 'bakery';
                }
                
                // Frozen
                if (name.match(/\b(frozen|ice cream|popsicle|frozen vegetables|frozen fruit|frozen meal)\b/)) {
                    return 'frozen';
                }
                
                // Pantry & Canned
                if (name.match(/\b(rice|pasta|noodle|bean|lentil|chickpea|quinoa|oats|cereal|granola|nut|almond|walnut|peanut|seed|oil|vinegar|sauce|soup|broth|stock|canned|jar|bottle|spice|salt|pepper|sugar|honey|syrup)\b/)) {
                    return 'pantry';
                }
                
                // Beverages
                if (name.match(/\b(juice|soda|water|tea|coffee|beer|wine|alcohol|drink|beverage)\b/)) {
                    return 'beverages';
                }
                
                // Snacks
                if (name.match(/\b(chip|cracker|cookie|candy|chocolate|snack|popcorn|pretzel)\b/)) {
                    return 'snacks';
                }
                
                return 'other';
            }

            renderShoppingList() {
                const container = document.getElementById('shoppingListContainer');
                if (!container) return;

                if (this.shoppingList.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>üõí No Shopping List Yet</h3>
                            <p>Generate a shopping list from your recipes or add items manually.</p>
                        </div>
                    `;
                    return;
                }

                const groupByAisle = document.getElementById('groupByAisle')?.checked ?? true;
                const showQuantities = document.getElementById('showQuantities')?.checked ?? true;
                const hideCompleted = document.getElementById('markCompleted')?.checked ?? false;

                let filteredItems = this.shoppingList;
                if (hideCompleted) {
                    filteredItems = this.shoppingList.filter(item => !item.completed);
                }

                if (filteredItems.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>‚úÖ All Items Completed!</h3>
                            <p>Great job! You've finished your shopping list.</p>
                        </div>
                    `;
                    return;
                }

                if (groupByAisle) {
                    this.renderShoppingListByAisle(filteredItems, showQuantities);
                } else {
                    this.renderShoppingListSimple(filteredItems, showQuantities);
                }
            }

            renderShoppingListByAisle(items, showQuantities) {
                const container = document.getElementById('shoppingListContainer');
                
                // Group items by aisle
                const aisleGroups = {};
                items.forEach(item => {
                    if (!aisleGroups[item.aisle]) {
                        aisleGroups[item.aisle] = [];
                    }
                    aisleGroups[item.aisle].push(item);
                });

                // Aisle order for better shopping experience
                const aisleOrder = ['produce', 'dairy', 'meat', 'bakery', 'frozen', 'pantry', 'beverages', 'snacks', 'health', 'household', 'other'];
                const aisleNames = {
                    produce: 'ü•¨ Produce',
                    dairy: 'ü•õ Dairy & Eggs',
                    meat: 'ü•© Meat & Seafood',
                    bakery: 'üçû Bakery',
                    frozen: '‚ùÑÔ∏è Frozen Foods',
                    pantry: 'ü•´ Pantry & Canned',
                    beverages: 'ü•§ Beverages',
                    snacks: 'üçø Snacks & Candy',
                    health: 'üíä Health & Beauty',
                    household: 'üßΩ Household',
                    other: 'üì¶ Other'
                };

                let html = '';
                aisleOrder.forEach(aisle => {
                    if (aisleGroups[aisle] && aisleGroups[aisle].length > 0) {
                        const completedCount = aisleGroups[aisle].filter(item => item.completed).length;
                        const totalCount = aisleGroups[aisle].length;
                        
                        html += `
                            <div class="aisle-group">
                                <div class="aisle-title">
                                    ${aisleNames[aisle]}
                                    <span class="aisle-count">${completedCount}/${totalCount}</span>
                                </div>
                                <div class="shopping-items">
                                    ${aisleGroups[aisle].map(item => this.renderShoppingItem(item, showQuantities)).join('')}
                                </div>
                            </div>
                        `;
                    }
                });

                // Add summary
                const totalItems = this.shoppingList.length;
                const completedItems = this.shoppingList.filter(item => item.completed).length;
                const remainingItems = totalItems - completedItems;

                html += `
                    <div class="shopping-summary">
                        <div class="shopping-stats">
                            <div class="stat-item">
                                <div class="stat-number">${totalItems}</div>
                                <div class="stat-label">Total Items</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${completedItems}</div>
                                <div class="stat-label">Completed</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${remainingItems}</div>
                                <div class="stat-label">Remaining</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${totalItems > 0 ? (completedItems / totalItems) * 100 : 0}%"></div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                this.attachShoppingItemListeners();
            }

            renderShoppingListSimple(items, showQuantities) {
                const container = document.getElementById('shoppingListContainer');
                
                let html = '<div class="aisle-group"><div class="aisle-title">üõí All Items</div><div class="shopping-items">';
                
                items.forEach(item => {
                    html += this.renderShoppingItem(item, showQuantities);
                });
                
                html += '</div></div>';
                
                container.innerHTML = html;
                this.attachShoppingItemListeners();
            }

            renderShoppingItem(item, showQuantities) {
                const quantityDisplay = showQuantities && item.quantity ? 
                    `<span class="shopping-item-quantity">${this.escapeHtml(item.quantity)}</span>` : '';
                
                return `
                    <div class="shopping-item ${item.completed ? 'completed' : ''}" data-item-id="${item.id}">
                        <input type="checkbox" class="shopping-checkbox" ${item.completed ? 'checked' : ''}>
                        <div class="shopping-item-content">
                            <div>
                                <div class="shopping-item-name">${this.escapeHtml(item.name)}</div>
                                ${quantityDisplay}
                                <div class="item-sources" style="font-size: 0.8rem; color: var(--soft-brown); margin-top: 2px;">
                                    ${item.sources.join(', ')}
                                </div>
                            </div>
                            <div class="shopping-item-actions">
                                <button class="btn-item-action" onclick="recipeKeeper.editShoppingItem('${item.id}')" title="Edit">‚úèÔ∏è</button>
                                <button class="btn-item-action" onclick="recipeKeeper.removeShoppingItem('${item.id}')" title="Remove">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            attachShoppingItemListeners() {
                document.querySelectorAll('.shopping-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const itemId = e.target.closest('.shopping-item').dataset.itemId;
                        const item = this.shoppingList.find(i => i.id === itemId);
                        if (item) {
                            item.completed = e.target.checked;
                            this.saveShoppingList();
                            this.renderShoppingList();
                        }
                    });
                });
            }

            addCustomItem() {
                document.getElementById('customItemModal').style.display = 'block';
            }

            closeCustomItemModal() {
                document.getElementById('customItemModal').style.display = 'none';
                document.getElementById('customItemName').value = '';
                document.getElementById('customItemQuantity').value = '';
                document.getElementById('customItemAisle').value = 'produce';
            }

            saveCustomItem() {
                const name = document.getElementById('customItemName').value.trim();
                const quantity = document.getElementById('customItemQuantity').value.trim();
                const aisle = document.getElementById('customItemAisle').value;

                if (!name) {
                    this.showMessage('Please enter an item name', 'error');
                    return;
                }

                this.addShoppingItem(`${quantity ? quantity + ' ' : ''}${name}`, 'Manual');
                this.saveShoppingList();
                this.renderShoppingList();
                this.closeCustomItemModal();
                this.showMessage('‚úÖ Item added to shopping list!', 'success');
            }

            editShoppingItem(itemId) {
                const item = this.shoppingList.find(i => i.id === itemId);
                if (!item) return;

                const newName = prompt('Edit item name:', item.name);
                if (newName && newName.trim() !== item.name) {
                    item.name = newName.trim();
                    item.aisle = this.detectAisle(newName);
                    this.saveShoppingList();
                    this.renderShoppingList();
                }
            }

            removeShoppingItem(itemId) {
                if (confirm('Remove this item from shopping list?')) {
                    this.shoppingList = this.shoppingList.filter(item => item.id !== itemId);
                    this.saveShoppingList();
                    this.renderShoppingList();
                }
            }

            clearShoppingList() {
                if (confirm('Clear entire shopping list? This cannot be undone.')) {
                    this.shoppingList = [];
                    this.saveShoppingList();
                    this.renderShoppingList();
                    this.showMessage('üóëÔ∏è Shopping list cleared', 'success');
                }
            }

            exportShoppingList() {
                if (this.shoppingList.length === 0) {
                    this.showMessage('No items to export', 'error');
                    return;
                }

                const exportData = {
                    generatedAt: new Date().toISOString(),
                    totalItems: this.shoppingList.length,
                    completedItems: this.shoppingList.filter(item => item.completed).length,
                    items: this.shoppingList
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `shopping-list-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                this.showMessage('üì§ Shopping list exported successfully!', 'success');
            }

            saveRecipes() {
                localStorage.setItem('recipe-keeper-recipes', JSON.stringify(this.recipes));
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showLoading(message = 'Processing...') {
                const existingLoader = document.getElementById('loading-overlay');
                if (existingLoader) return;

                const loader = document.createElement('div');
                loader.id = 'loading-overlay';
                loader.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--warm-white); padding: 30px; border-radius: 15px; box-shadow: 0 8px 32px var(--shadow); text-align: center;">
                            <div style="width: 40px; height: 40px; border: 3px solid var(--light-sage); border-top: 3px solid var(--sage); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto;"></div>
                            <p style="color: var(--deep-sage); font-family: 'Crimson Text', serif; font-size: 1.1rem;">${message}</p>
                        </div>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                document.body.appendChild(loader);
            }

            hideLoading() {
                const loader = document.getElementById('loading-overlay');
                if (loader) {
                    loader.remove();
                }
            }

            showBackupOptions() {
                const modal = document.createElement('div');
                modal.id = 'backup-modal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--warm-white); padding: 40px; border-radius: 20px; box-shadow: 0 8px 32px var(--shadow); max-width: 500px; width: 90%; text-align: center;">
                            <h3 style="color: var(--deep-sage); font-family: 'Libre Baskerville', serif; margin-bottom: 20px; font-size: 1.8rem;">Recipe Backup & Restore</h3>
                            <p style="color: var(--soft-brown); margin-bottom: 30px; font-size: 1.1rem;">Keep your recipes safe with backup and restore options.</p>
                            
                            <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px;">
                                <button id="export-recipes" style="background: var(--sage); color: white; border: none; padding: 15px 20px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1.1rem; cursor: pointer;">
                                    üì• Export All Recipes
                                </button>
                                <label for="import-file" style="background: var(--light-sage); color: white; border: none; padding: 15px 20px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1.1rem; cursor: pointer; display: block;">
                                    üì§ Import Recipes from File
                                </label>
                                <input type="file" id="import-file" accept=".json" style="display: none;">
                                <button id="clear-all-data" style="background: var(--terracotta); color: white; border: none; padding: 15px 20px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1.1rem; cursor: pointer;">
                                    üóëÔ∏è Clear All Data
                                </button>
                            </div>
                            
                            <div style="margin-bottom: 20px; padding: 15px; background: var(--light-sage); border-radius: 10px; color: white; font-size: 0.9rem;">
                                <strong>üìä Current Status:</strong><br>
                                <span id="recipe-count">${this.recipes.length} recipes stored</span><br>
                                <span id="storage-info">Checking storage...</span>
                            </div>
                            
                            <button id="close-backup" style="background: var(--soft-brown); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-family: 'Crimson Text', serif; font-size: 1rem; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Update storage info
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    navigator.storage.estimate().then(estimate => {
                        const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                        const quotaMB = (estimate.quota / 1024 / 1024).toFixed(2);
                        document.getElementById('storage-info').textContent = `${usedMB}MB used of ${quotaMB}MB available`;
                    });
                }

                // Event listeners
                document.getElementById('export-recipes').addEventListener('click', () => this.exportRecipes());
                document.getElementById('import-file').addEventListener('change', (e) => this.importRecipes(e));
                document.getElementById('clear-all-data').addEventListener('click', () => this.clearAllData());
                document.getElementById('close-backup').addEventListener('click', () => modal.remove());
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            exportRecipes() {
                const backup = {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    recipeCount: this.recipes.length,
                    recipes: this.recipes
                };

                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `recipe-keeper-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(link.href);
                
                // Show success message
                this.showMessage('‚úÖ Recipes exported successfully!', 'success');
            }

            importRecipes(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (!backup.recipes || !Array.isArray(backup.recipes)) {
                            throw new Error('Invalid backup file format');
                        }

                        // Merge with existing recipes (avoid duplicates by ID)
                        const existingIds = new Set(this.recipes.map(r => r.id));
                        const newRecipes = backup.recipes.filter(r => !existingIds.has(r.id));
                        
                        this.recipes.push(...newRecipes);
                        this.saveRecipes();
                        this.renderRecipes();
                        
                        document.getElementById('backup-modal').remove();
                        this.showMessage(`‚úÖ Imported ${newRecipes.length} new recipes!`, 'success');
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        this.showMessage('‚ùå Error importing recipes. Please check the file format.', 'error');
                    }
                };
                reader.readAsText(file);
            }

            clearAllData() {
                if (confirm(`‚ö†Ô∏è Are you sure you want to delete ALL ${this.recipes.length} recipes?\n\nThis action cannot be undone. Consider exporting your recipes first.`)) {
                    localStorage.removeItem('recipe-keeper-recipes');
                    this.recipes = [];
                    this.renderRecipes();
                    document.getElementById('backup-modal').remove();
                    this.showMessage('üóëÔ∏è All recipe data cleared.', 'info');
                }
            }

            showMessage(message, type = 'info') {
                const colors = {
                    success: 'var(--sage)',
                    error: 'var(--terracotta)',
                    info: 'var(--soft-brown)'
                };

                const messageDiv = document.createElement('div');
                messageDiv.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; font-family: 'Crimson Text', serif;">
                        ${message}
                    </div>
                `;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 4000);
            }
        }

        // Initialize the app
        const recipeKeeper = new RecipeKeeper();

        // Request persistent storage for better data retention
        if ('storage' in navigator && 'persist' in navigator.storage) {
            navigator.storage.persist().then(persistent => {
                if (persistent) {
                    console.log('‚úÖ Persistent storage granted - recipes will be protected from automatic cleanup');
                } else {
                    console.log('‚ö†Ô∏è Persistent storage not granted - recipes may be cleared under storage pressure');
                }
            });
        }

        // Monitor storage usage
        if ('storage' in navigator && 'estimate' in navigator.storage) {
            navigator.storage.estimate().then(estimate => {
                const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                const quotaMB = (estimate.quota / 1024 / 1024).toFixed(2);
                console.log(`üìä Storage: ${usedMB}MB used of ${quotaMB}MB available`);
            });
        }

        // PWA Installation and Service Worker
        class PWAManager {
            constructor() {
                this.deferredPrompt = null;
                this.installButton = null;
                this.initializePWA();
            }

            async initializePWA() {
                // Register service worker
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.log('Service Worker registered:', registration.scope);
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    this.showUpdateNotification();
                                }
                            });
                        });
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }

                // Handle PWA install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallButton();
                });

                // Handle PWA install success
                window.addEventListener('appinstalled', () => {
                    console.log('PWA installed successfully');
                    this.hideInstallButton();
                    this.showInstallSuccessMessage();
                });

                // Check if already installed
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                    console.log('App is running as PWA');
                    document.body.classList.add('pwa-installed');
                }
            }

            showInstallButton() {
                if (this.installButton) return;

                this.installButton = document.createElement('button');
                this.installButton.className = 'nav-btn install-btn';
                this.installButton.innerHTML = 'üì± Install App';
                this.installButton.style.background = 'var(--terracotta)';
                this.installButton.addEventListener('click', () => this.installPWA());

                const nav = document.querySelector('.main-nav');
                nav.appendChild(this.installButton);
            }

            hideInstallButton() {
                if (this.installButton) {
                    this.installButton.remove();
                    this.installButton = null;
                }
            }

            async installPWA() {
                if (!this.deferredPrompt) return;

                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                
                console.log('Install prompt outcome:', outcome);
                this.deferredPrompt = null;
                
                if (outcome === 'dismissed') {
                    this.hideInstallButton();
                }
            }

            showUpdateNotification() {
                const notification = document.createElement('div');
                notification.className = 'update-notification';
                notification.innerHTML = `
                    <div style="background: var(--sage); color: white; padding: 15px; border-radius: 10px; margin: 20px; text-align: center; box-shadow: 0 4px 15px rgba(156, 175, 136, 0.3);">
                        <p style="margin-bottom: 10px;">A new version is available!</p>
                        <button onclick="this.parentElement.parentElement.remove(); location.reload();" 
                                style="background: white; color: var(--sage); border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-family: 'Crimson Text', serif;">
                            Update Now
                        </button>
                        <button onclick="this.parentElement.parentElement.remove();" 
                                style="background: transparent; color: white; border: 1px solid white; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-left: 10px; font-family: 'Crimson Text', serif;">
                            Later
                        </button>
                    </div>
                `;
                
                document.body.insertBefore(notification, document.body.firstChild);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 10000);
            }

            showInstallSuccessMessage() {
                const message = document.createElement('div');
                message.innerHTML = `
                    <div style="background: var(--sage); color: white; padding: 15px; border-radius: 10px; margin: 20px; text-align: center; box-shadow: 0 4px 15px rgba(156, 175, 136, 0.3);">
                        <p>üéâ App installed successfully! You can now use Recipe Keeper offline.</p>
                    </div>
                `;
                
                document.body.insertBefore(message, document.body.firstChild);
                
                setTimeout(() => {
                    if (message.parentElement) {
                        message.remove();
                    }
                }, 5000);
            }
        }

        // Initialize PWA functionality
        const pwaManager = new PWAManager();

        // Handle deep links for PWA shortcuts
        window.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash === '#add') {
                recipeKeeper.switchSection('import');
            } else if (hash === '#recipes') {
                recipeKeeper.switchSection('recipes');
            }
        });
    </script>
</body>
</html>